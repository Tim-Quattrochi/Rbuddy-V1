### **Story 3: Daily Ritual FSM (Part 1 - Mood)**

**User Story:**
As a returning citizen, when I interact with the daily check-in, I want to be prompted for my mood and have my selection recognized, so that I can complete the first step of my ritual.

**Story Context:**
*   **Existing System Integration:** This story integrates the `ConversationEngine` with the `sms` webhook created in the previous story.
*   **Technology:** TypeScript, Twilio.
*   **Follows pattern:** Implements the `ConversationEngine` and `ConversationState` interfaces as defined in `docs/architecture/component-architecture.md`.
*   **Touch points:**
    *   A new file at `server/services/conversationEngine.ts`.
    *   The `api/webhooks/twilio/sms.ts` handler will be updated to call the `ConversationEngine`.

**Acceptance Criteria:**
1.  The `ConversationEngine` class is created at `server/services/conversationEngine.ts`.
2.  The SMS webhook handler is updated to instantiate and call the `ConversationEngine.processInput()` method, passing the sender's phone number and message body.
3.  The `ConversationEngine` identifies the start of a new "daily ritual" flow.
4.  The engine responds to the user with the initial mood prompt message (e.g., "Welcome to your daily check-in. How are you feeling? Reply with: 1 for Calm, 2 for Stressed, 3 for Tempted, or 4 for Hopeful.").
5.  The engine correctly parses the user's subsequent numeric reply (1, 2, 3, or 4) as their mood.
6.  The selected mood is stored within the `ConversationState` for the current user's session.
7.  If the user sends an invalid response, the engine replies with a helpful error message and re-prompts for a valid mood selection.

**Technical Notes:**
*   **Integration Approach:** The `ConversationEngine` will be instantiated within the webhook handler. For this story, the conversation state can be managed in memory.
*   **Existing Pattern Reference:** The `ConversationEngine` class structure and `ConversationState` interface should match the definitions in `docs/architecture/component-architecture.md`.
*   **Key Constraints:** The FSM logic should be contained entirely within the `ConversationEngine`. The webhook handler should only be responsible for I/O and validation.

**Definition of Done:**
*   [x] The `ConversationEngine` is created and integrated with the SMS webhook.
*   [x] The system correctly sends the mood prompt and parses a valid user response.
*   [x] Invalid user input is handled gracefully.
*   [x] Unit tests for the mood-prompt and mood-parsing logic within the `ConversationEngine` pass.
*   [x] Code has been reviewed and approved by the Architect.

**Dev Agent Record:**

**Status:** Complete ✅

**Architect Review Notes:**
- ✨ Excellent FSM implementation with clean separation of concerns
- ConversationState and ConversationEngine interfaces match architecture spec perfectly
- FSM logic isolated in engine, webhook handles I/O only (ideal separation)
- State management supports concurrent users correctly
- Graceful error handling with user-friendly messages
- Well-documented with JSDoc comments, type-safe TypeScript
- Future-proofed with placeholder methods (getNextMessage, saveSession)
- Comprehensive test coverage: 16 unit + 3 integration tests (19/19 passing ✅)
- In-memory state appropriate for Story 3 MVP scope
- Channel abstraction supports SMS + IVR
- Approved by: Winston (Architect)

**Agent Model Used:** Claude Sonnet 4.5

**File List:**
*   `server/services/conversationEngine.ts` (new)
*   `server/services/conversationEngine.test.ts` (new)
*   `api/webhooks/twilio/sms.ts` (modified)
*   `api/webhooks/twilio/sms.test.ts` (modified)

**Change Log:**
*   Created `ConversationEngine` class implementing FSM for daily ritual flow
*   Implemented `ConversationState` interface with in-memory state storage
*   Added mood prompt functionality with 4 mood options (calm, stressed, tempted, hopeful)
*   Implemented input validation with helpful error messages and re-prompting
*   Integrated ConversationEngine with SMS webhook handler
*   Added error handling with fallback messages (10s Twilio timeout compliance)
*   Created comprehensive unit tests (16 tests) covering:
  - Initial mood prompt for new users
  - Valid mood selection (1-4) with state persistence
  - Invalid input handling with re-prompting
  - State management for multiple concurrent users
  - SMS and IVR channel support
*   Updated SMS webhook tests (3 tests) to verify ConversationEngine integration
*   All tests passing (19/19 total)
