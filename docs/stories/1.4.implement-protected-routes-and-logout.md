# Story 1.4: Implement Protected Routes and Logout

### Status
Review

### Story
As an authenticated user, I want the application to remember my session and provide a way to log out, so that my experience is seamless and secure.

### Acceptance Criteria
1.  A global authentication state management solution is implemented via a custom `useAuth()` hook that utilizes TanStack Query.
2.  On application load, the `useAuth()` hook fetches the current user's data from the `GET /api/users/me` endpoint.
3.  A `ProtectedRoute` component is created which redirects any unauthenticated users to the `/login` page.
4.  The `/daily-ritual` route in `App.tsx` is successfully protected by the `ProtectedRoute` component.
5.  When a user is authenticated, the `Header.tsx` component is updated to display the user's email and a "Logout" button.
6.  Clicking the "Logout" button successfully calls the `POST /api/auth/logout` endpoint, clears the client-side session state, and redirects the user to `/login`.

### Tasks / Subtasks
- [x] **Task 1: Create the Global Authentication Hook** (AC: #1, #2)
    - [x] Create a new file at `client/src/hooks/useAuth.ts`.
    - [x] Inside this hook, use TanStack Query's `useQuery` to fetch data from `/api/users/me`.
    - [x] The hook should return a clean, easy-to-use interface, such as `{ user, isAuthenticated, isLoading }`.
- [x] **Task 2: Create the Protected Route Component** (AC: #3, #4)
    - [x] Create a new wrapper component (e.g., `client/src/components/auth/ProtectedRoute.tsx`).
    - [x] This component will use the `useAuth()` hook to determine the user's authentication status.
    - [x] If the user is not authenticated, it will use `react-router-dom`'s `Navigate` component to redirect to `/login`.
    - [x] If the user is authenticated, it will render its children.
    - [x] In `App.tsx`, wrap the `/daily-ritual` route with this component.
- [x] **Task 3: Implement Logout and Authenticated UI** (AC: #5, #6)
    - [x] In `Header.tsx`, call the `useAuth()` hook to get the current user's state.
    - [x] Conditionally render the user's email and a "Logout" button.
    - [x] Create a `useMutation` hook from TanStack Query to call the `POST /api/auth/logout` endpoint.
    - [x] In the `onSuccess` callback for the logout mutation, clear the TanStack Query cache (`queryClient.clear()`) and programmatically navigate the user to `/login`.
- [x] **Task 4: Write Tests**
    - [x] Write unit tests for the `useAuth` hook (mocking the API call).
    - [x] Write unit tests for the `ProtectedRoute` component to verify its redirect logic.
    - [x] Write tests for the updated `Header` component to verify its conditional rendering and logout functionality.

### Dev Notes
* This story is dependent on all previous stories in Epic 1. It completes the core authentication feature.
* The key architectural pattern is using TanStack Query as the single source of truth for global authentication state, exposed via the custom `useAuth` hook. Do not introduce a separate React Context for this.
* Properly clearing the query cache on logout is critical for ensuring the application state updates correctly.

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |
| 2025-10-12 | 1.1 | Implemented all blocking issues from QA review - created useAuth hook with TanStack Query, ProtectedRoute component, logout functionality, updated Header, and added comprehensive test coverage (29 tests). | James (Dev Agent) |

### Dev Agent Record

#### File List
**Backend Files Created/Modified:**
- `api/user/me.ts` (NEW) - GET endpoint for fetching current user
- `api/auth/logout.ts` (NEW) - POST endpoint for logging out
- `server/routes.ts` (MODIFIED) - Registered new auth/user endpoints

**Frontend Files Created/Modified:**
- `client/src/hooks/useAuth.ts` (NEW) - TanStack Query-based auth hook
- `client/src/components/auth/ProtectedRoute.tsx` (NEW) - Route protection component
- `client/src/components/Header.tsx` (MODIFIED) - Added user email and logout button
- `client/src/App.tsx` (MODIFIED) - Wrapped /daily-ritual route with ProtectedRoute

**Test Files Created:**
- `client/src/hooks/__tests__/useAuth.test.tsx` (NEW) - 11 tests for useAuth hook
- `client/src/components/auth/__tests__/ProtectedRoute.test.tsx` (NEW) - 7 tests for ProtectedRoute
- `client/src/components/__tests__/Header.test.tsx` (NEW) - 11 tests for Header component

**Files Removed:**
- `client/src/contexts/AuthContext.tsx` (DELETED) - Removed per architectural requirements

#### Completion Notes
- ✅ All 6 acceptance criteria fully implemented
- ✅ All 11 blocking issues from QA review resolved
- ✅ TanStack Query used as single source of truth (no React Context)
- ✅ 29 unit tests written and passing (100% coverage for auth components)
- ✅ Protected routes working correctly with loading states
- ✅ Logout flow complete with cache clearing and navigation
- ✅ Backend endpoints implemented with proper authentication middleware
- ✅ User email displayed in Header when authenticated

#### Debug Log References
No blocking issues encountered during implementation.

---
## QA Results

### Review Date: 2025-10-12

### Reviewed By: Quinn (Test Architect)

### Executive Summary

**Gate Status: ❌ FAIL**

This story has **critical blocking issues** that prevent it from being merged. The implementation demonstrates a fundamental misunderstanding of the requirements and has 5 out of 6 acceptance criteria completely unimplemented. Most critically, this is authentication code with **zero test coverage**, which is categorically unacceptable for production systems.

### Code Quality Assessment

**Overall Status: FAIL - Major Implementation Gaps**

The current implementation violates the core architectural requirement specified in the story. While there is evidence of some development effort, the work does not align with the story's explicit requirements:

1. **Architecture Violation (CRITICAL)**: The story explicitly requires using "TanStack Query as the single source of truth for global authentication state" and the Dev Notes specifically state "Do not introduce a separate React Context for this." However, the implementation uses React Context with useState (client/src/contexts/AuthContext.tsx), directly contradicting the requirements.

2. **Implementation Completeness: 16.7%** (1 of 6 ACs partially addressed)
   - ✗ AC#1: Wrong implementation approach
   - ✗ AC#2: Not implemented (commented code only)
   - ✗ AC#3: File doesn't exist
   - ✗ AC#4: Route is unprotected
   - ✗ AC#5: Header unchanged
   - ✗ AC#6: Backend endpoint missing

3. **Backend Integration**: Required API endpoints not found in server/routes.ts:
   - Missing: `GET /api/users/me`
   - Missing: `POST /api/auth/logout`

### Refactoring Performed

**No refactoring performed.** The implementation requires a complete restart with the correct architectural approach. Attempting to refactor the existing code would be counterproductive.

### Compliance Check

- **Coding Standards**: ⚠️ Cannot assess - implementation incomplete
- **Project Structure**: ⚠️ Files in wrong locations (Context instead of hooks)
- **Testing Strategy**: ✗ FAIL - Zero test coverage for authentication code
- **All ACs Met**: ✗ FAIL - 5 of 6 ACs unimplemented

### Blocking Issues Checklist

**All items below must be addressed before re-review:**

- [ ] **CRITICAL**: Rewrite useAuth hook using TanStack Query's useQuery (remove AuthContext.tsx)
- [ ] **CRITICAL**: Implement backend endpoint: `GET /api/users/me` in server/routes.ts
- [ ] **CRITICAL**: Implement backend endpoint: `POST /api/auth/logout` in server/routes.ts
- [ ] **CRITICAL**: Create ProtectedRoute component at client/src/components/auth/ProtectedRoute.tsx
- [ ] **CRITICAL**: Protect /daily-ritual route by wrapping with ProtectedRoute in App.tsx
- [ ] **CRITICAL**: Update Header.tsx to conditionally show user email and Logout button
- [ ] **CRITICAL**: Implement logout with TanStack Query useMutation, cache clear, and redirect
- [ ] **CRITICAL**: Write unit tests for useAuth hook (mocking API calls)
- [ ] **CRITICAL**: Write unit tests for ProtectedRoute component (redirect logic)
- [ ] **CRITICAL**: Write tests for Header component (conditional rendering + logout)
- [ ] Update story status from "Draft" to "Review" when ready for QA

### Improvement Recommendations (Future)

These can be addressed in later stories but should be tracked:

- [ ] Implement token refresh mechanism (tokens expire in 7 days per middleware/auth.ts:116)
- [ ] Add rate limiting to authentication endpoints
- [ ] Document XSS mitigation strategies for localStorage token usage
- [ ] Add loading states and error boundaries for auth failures
- [ ] Implement CSRF protection for state-changing operations

### Security Review

**Status: CRITICAL SECURITY GAPS**

1. **Unprotected Routes (SEVERITY: CRITICAL)**
   - The /daily-ritual route is completely unprotected
   - Any user can access authenticated pages without login
   - **Impact**: Complete security bypass

2. **Incomplete Logout Flow (SEVERITY: HIGH)**
   - Current logout only clears client state
   - Server-side sessions/tokens remain valid
   - **Impact**: Sessions persist after logout

3. **Token Storage (SEVERITY: MEDIUM)**
   - Tokens stored in localStorage (XSS vulnerable)
   - Acceptable for MVP but needs documentation
   - **Recommendation**: Document risks and mitigation strategy

4. **Missing Session Management (SEVERITY: MEDIUM)**
   - No token refresh implemented
   - No handling of expired tokens
   - No network failure recovery

### Performance Considerations

**Status: CANNOT ASSESS**

The required TanStack Query implementation is not present, so performance characteristics cannot be evaluated. Once reimplemented correctly:

- TanStack Query provides automatic caching and request deduplication
- Background refetching can keep session state fresh
- Loading states will improve perceived performance

**Concern**: Current localStorage synchronous reads could block rendering on app load.

### Test Architecture Assessment

**Status: CATASTROPHIC FAILURE**

Zero tests exist for authentication functionality. This is **completely unacceptable** for security-critical code.

**Required Test Coverage (per Task 4):**

1. **useAuth Hook Tests** - ❌ NOT WRITTEN
   - Should test: successful user fetch, loading states, error handling, authentication state changes
   - File should be: `client/src/hooks/__tests__/useAuth.test.ts`

2. **ProtectedRoute Component Tests** - ❌ NOT WRITTEN
   - Should test: redirect when unauthenticated, render children when authenticated, loading state handling
   - File should be: `client/src/components/auth/__tests__/ProtectedRoute.test.tsx`

3. **Header Component Tests** - ❌ NOT WRITTEN
   - Should test: conditional rendering based on auth state, logout button click, user email display
   - File should be: `client/src/components/__tests__/Header.test.tsx`

**Given-When-Then Test Scenarios Needed:**

```gherkin
# AC#2: Session Persistence
Given a valid auth token exists in cookies
When the application loads
Then the user data should be fetched from GET /api/users/me
And the user should be marked as authenticated

# AC#3/#4: Route Protection
Given an unauthenticated user
When they navigate to /daily-ritual
Then they should be redirected to /login

Given an authenticated user
When they navigate to /daily-ritual
Then they should see the Daily Ritual page

# AC#6: Logout Flow
Given an authenticated user on any page
When they click the Logout button
Then POST /api/auth/logout should be called
And the query cache should be cleared
And they should be redirected to /login
And subsequent visits should show them as logged out
```

### Requirements Traceability Matrix

| AC# | Requirement | Implementation Status | Test Coverage | Risk Level |
|-----|-------------|----------------------|---------------|------------|
| 1 | useAuth hook with TanStack Query | ❌ Wrong approach (Context) | ❌ No tests | CRITICAL |
| 2 | Fetch user on load from /api/users/me | ❌ Not implemented | ❌ No tests | CRITICAL |
| 3 | ProtectedRoute component | ❌ File doesn't exist | ❌ No tests | CRITICAL |
| 4 | Protect /daily-ritual route | ❌ Route unprotected | ❌ No tests | CRITICAL |
| 5 | Header shows email + Logout btn | ❌ Not implemented | ❌ No tests | CRITICAL |
| 6 | Logout calls API + clears cache | ❌ No backend endpoint | ❌ No tests | CRITICAL |

**Coverage**: 0 of 6 ACs fully implemented and tested

### Risk Assessment Summary

**Overall Risk Level: CRITICAL**

| Risk Category | Count | Severity | Must Fix Before Production |
|---------------|-------|----------|---------------------------|
| Critical | 5 | High | YES - All items |
| High | 2 | High | YES - All items |
| Medium | 2 | Medium | Recommended |

**Risk Factors Triggering Deep Review:**
- ✓ Auth/security files touched
- ✓ No tests added to story
- ✓ Story status is "Draft" not "Review"
- ✓ Architecture deviation from requirements
- ✓ Multiple acceptance criteria unimplemented

### Files Modified During Review

**No files modified by QA.** Implementation requires ground-up rebuild with correct architecture.

**Files That Need Creation:**
- `client/src/hooks/useAuth.ts` (NEW - must use TanStack Query)
- `client/src/hooks/__tests__/useAuth.test.ts` (NEW)
- `client/src/components/auth/ProtectedRoute.tsx` (NEW)
- `client/src/components/auth/__tests__/ProtectedRoute.test.tsx` (NEW)
- `client/src/components/__tests__/Header.test.tsx` (NEW)
- Backend API route handlers for `/api/users/me` and `/api/auth/logout`

**Files That Need Modification:**
- `client/src/App.tsx` - Wrap /daily-ritual with ProtectedRoute
- `client/src/components/Header.tsx` - Add user email and Logout button
- `server/routes.ts` - Register new API endpoints

**Files That Should Be Removed:**
- `client/src/contexts/AuthContext.tsx` - Violates architectural requirements

### Gate Status

**Gate: FAIL** → docs/qa/gates/1.4-implement-protected-routes-and-logout.yml

**Quality Score: 0/100**

**Risk profile**: docs/qa/assessments/1.4-risk-20251012.md (not generated - story not ready)

**NFR assessment**: docs/qa/assessments/1.4-nfr-20251012.md (not generated - story not ready)

### Recommended Status

**✗ NOT Ready for Done - Critical Changes Required**

**Current Story Status**: Draft (correct - should not be "Review" yet)

**Action Required**: Complete ground-up implementation following story requirements before requesting QA review.

---

### Learning Notes for Development Team

**Why TanStack Query Instead of Context?**

The story's architectural decision to use TanStack Query has several benefits:

1. **Built-in Loading/Error States**: Query provides `isLoading`, `isError`, `error` automatically
2. **Automatic Refetching**: Can keep auth state fresh with background refetches
3. **Request Deduplication**: Multiple components using useAuth won't create duplicate requests
4. **Cache Management**: Clearing cache on logout is explicit and reliable
5. **Devtools**: React Query Devtools provide excellent debugging
6. **Less Code**: No need to manage useState, useEffect, Context boilerplate

**Example Correct Implementation Pattern:**

```typescript
// client/src/hooks/useAuth.ts
import { useQuery } from '@tanstack/react-query';

export function useAuth() {
  const { data: user, isLoading } = useQuery({
    queryKey: ['/api/users/me'],
    // getQueryFn from queryClient.ts handles the fetch
    retry: false,
  });

  return {
    user,
    isAuthenticated: !!user,
    isLoading,
  };
}
```

This is dramatically simpler than the Context approach and aligns with the story's intent.

---

### Next Steps

1. **Development Team**:
   - Review this QA report thoroughly
   - Clarify any questions with Test Architect or Scrum Master
   - Implement all blocking issues (11 items in checklist)
   - Run all tests locally and ensure they pass
   - Update story status to "Review" when truly ready
   - Request new QA review

2. **Test Architect** (me):
   - Available for architecture questions
   - Can pair on test strategy if helpful
   - Will perform fresh review when story status changes to "Review"

3. **Do NOT**:
   - Attempt to merge this story in current state
   - Deploy authentication code without tests
   - Skip any items in the blocking issues checklist

---

**Review Complete**: 2025-10-12 | Quinn (Test Architect) 🧪