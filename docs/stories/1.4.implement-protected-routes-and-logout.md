# Story 1.4: Implement Protected Routes and Logout

### Status
Draft

### Story
As an authenticated user, I want the application to remember my session and provide a way to log out, so that my experience is seamless and secure.

### Acceptance Criteria
1.  A global authentication state management solution is implemented via a custom `useAuth()` hook that utilizes TanStack Query.
2.  On application load, the `useAuth()` hook fetches the current user's data from the `GET /api/users/me` endpoint.
3.  A `ProtectedRoute` component is created which redirects any unauthenticated users to the `/login` page.
4.  The `/daily-ritual` route in `App.tsx` is successfully protected by the `ProtectedRoute` component.
5.  When a user is authenticated, the `Header.tsx` component is updated to display the user's email and a "Logout" button.
6.  Clicking the "Logout" button successfully calls the `POST /api/auth/logout` endpoint, clears the client-side session state, and redirects the user to `/login`.

### Tasks / Subtasks
- [ ] **Task 1: Create the Global Authentication Hook** (AC: #1, #2)
    - [ ] Create a new file at `client/src/hooks/useAuth.ts`.
    - [ ] Inside this hook, use TanStack Query's `useQuery` to fetch data from `/api/users/me`.
    - [ ] The hook should return a clean, easy-to-use interface, such as `{ user, isAuthenticated, isLoading }`.
- [ ] **Task 2: Create the Protected Route Component** (AC: #3, #4)
    - [ ] Create a new wrapper component (e.g., `client/src/components/auth/ProtectedRoute.tsx`).
    - [ ] This component will use the `useAuth()` hook to determine the user's authentication status.
    - [ ] If the user is not authenticated, it will use `react-router-dom`'s `Maps` component to redirect to `/login`.
    - [ ] If the user is authenticated, it will render its children.
    - [ ] In `App.tsx`, wrap the `/daily-ritual` route with this component.
- [ ] **Task 3: Implement Logout and Authenticated UI** (AC: #5, #6)
    - [ ] In `Header.tsx`, call the `useAuth()` hook to get the current user's state.
    - [ ] Conditionally render the user's email and a "Logout" button.
    - [ ] Create a `useMutation` hook from TanStack Query to call the `POST /api/auth/logout` endpoint.
    - [ ] In the `onSuccess` callback for the logout mutation, clear the TanStack Query cache (`queryClient.clear()`) and programmatically navigate the user to `/login`.
- [ ] **Task 4: Write Tests**
    - [ ] Write unit tests for the `useAuth` hook (mocking the API call).
    - [ ] Write unit tests for the `ProtectedRoute` component to verify its redirect logic.
    - [ ] Write tests for the updated `Header` component to verify its conditional rendering and logout functionality.

### Dev Notes
* This story is dependent on all previous stories in Epic 1. It completes the core authentication feature.
* The key architectural pattern is using TanStack Query as the single source of truth for global authentication state, exposed via the custom `useAuth` hook. Do not introduce a separate React Context for this.
* Properly clearing the query cache on logout is critical for ensuring the application state updates correctly.

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |