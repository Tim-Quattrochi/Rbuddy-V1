# Story 1.3: Build Frontend Login UI & Initiate Flow

### Status
Ready for Review

### Story
**As a** user,  
**I want** to see a clear "Sign in with Google" option and be able to initiate the login process,  
**so that** I can securely access the application using my Google account.

### Acceptance Criteria
1.  The existing `client/src/pages/Login.tsx` is refactored to replace email/password fields with Google OAuth login.
2.  A route for `/login` already exists in `client/src/App.tsx` and correctly renders the updated `LoginPage` component.
3.  The `/login` page displays a "Sign in with Google" button that is visually consistent with the `shadcn/ui` theme and includes the Google logo/icon.
4.  Clicking the "Sign in with Google" button navigates the user's browser to the backend's `GET /api/auth/google` endpoint, thereby initiating the Google OAuth flow.
5.  The login page is responsive and displays correctly on mobile, tablet, and desktop screen sizes.
6.  The "Get Started" button on the `Landing.tsx` page (via `Hero.tsx` component) links to the `/login` page.
7.  The login page includes appropriate loading states and error handling for edge cases.
8.  The page maintains visual consistency with the calming, recovery-focused design system (soft colors, clear typography, accessible contrasts).

### Tasks / Subtasks
- [x] **Task 1: Refactor the Login Page Component** (AC: #1, #3, #5, #8)
    - [x] Remove existing email/password form fields from `client/src/pages/Login.tsx`.
    - [x] Replace with a centered card layout using `shadcn/ui` components (`Card`, `CardHeader`, `CardTitle`, `CardDescription`, `CardContent`).
    - [x] Add a welcoming title (e.g., "Welcome to Reentry Buddy") and supportive description text.
    - [x] Create a prominent "Sign in with Google" button with Google branding (consider using Lucide's `Chrome` icon or a custom Google SVG).
    - [x] Ensure the button has proper hover states, accessibility attributes (aria-label), and focus styles.
    - [x] Style the page to match the calming aesthetic from `Landing.tsx` (reuse `Header` and `Footer` components if appropriate).
    - [x] Test responsive behavior on mobile (320px+), tablet (768px+), and desktop (1024px+) viewports.
- [x] **Task 2: Implement the OAuth Initiation Action** (AC: #4)
    - [x] Convert the "Sign in with Google" button to either:
      - Option A: A standard anchor tag (`<a href="/api/auth/google">`) styled as a button, OR
      - Option B: A button with `onClick` that performs `window.location.href = '/api/auth/google'`
    - [x] Ensure the navigation is a full-page redirect (not a SPA navigation) to allow Passport.js to handle the OAuth flow.
    - [x] Add optional loading state if using button approach (disable button and show spinner while redirecting).
- [x] **Task 3: Verify and Update Application Routing** (AC: #2, #6)
    - [x] Confirm the `/login` route is correctly configured in `client/src/App.tsx` (route already exists, just verify).
    - [x] Locate the "Get Started" button in `client/src/components/Hero.tsx`.
    - [x] Verify it links to `/login` (if it currently links to `/check-in`, update the route).
    - [x] Test navigation flow: Landing → Login → OAuth redirect.
- [x] **Task 4: Add Error Handling and Edge Cases** (AC: #7)
    - [x] Add URL parameter parsing to detect error states (e.g., `?error=auth_failed`).
    - [x] Display user-friendly error messages using `shadcn/ui` Alert component if error parameters are present.
    - [x] Handle the case where the user is already authenticated (optional: redirect to `/daily-ritual` automatically).
- [x] **Task 5: Write Tests**
    - [x] Create or update test file: `client/src/pages/Login.test.tsx`.
    - [x] Test: Component renders with "Sign in with Google" button.
    - [x] Test: Button includes correct href or onClick handler pointing to `/api/auth/google`.
    - [x] Test: Component is responsive (snapshot tests for different viewport sizes).
    - [x] Test: Error message displays when `?error` query param is present.
    - [x] Test: Accessibility - button has proper ARIA labels and keyboard navigation works.
    - [x] Use Vitest + React Testing Library as per project standards.

### Dev Notes

#### Dependencies
* **Prerequisite**: Story 1.2 (Backend Google OAuth Callback) must be complete and deployed.
* **Backend Endpoints Available**:
  - `GET /api/auth/google` - Initiates OAuth flow (redirects to Google)
  - `GET /api/auth/google/callback` - Handles callback and sets `auth_token` cookie
  - Cookie-based authentication is now working (verified in Story 1.2 hotfix)

#### Relevant Source Tree
```
client/src/
├── pages/
│   ├── Login.tsx          # THIS FILE - Refactor for Google OAuth
│   ├── Landing.tsx        # Reuse Header/Footer for consistency
│   └── DailyRitual.tsx    # Target page after successful login
├── components/
│   ├── Hero.tsx           # Update "Get Started" button link
│   ├── Header.tsx         # Reusable header component
│   ├── Footer.tsx         # Reusable footer component
│   └── ui/                # shadcn/ui components (Button, Card, Alert, etc.)
├── contexts/
│   └── AuthContext.tsx    # Existing auth context (may need updates in Story 1.4)
└── App.tsx                # Route configuration (already has /login route)
```

#### Key Implementation Notes from Story 1.2
1. **Authentication Flow**:
   - OAuth initiation: User clicks button → Full page redirect to `/api/auth/google`
   - Passport.js handles Google redirect and callback
   - On success: JWT set as `HttpOnly` cookie → User redirected to `/daily-ritual`
   - On error: User redirected to `/login?error=auth_failed`

2. **Cookie-Based Auth**:
   - JWT stored in `auth_token` cookie (HttpOnly, Secure in production, SameSite=lax)
   - Cookie lifetime: 7 days
   - All API requests use `credentials: 'include'` to send cookies

3. **Security Considerations**:
   - No client-side token storage needed (cookies handled automatically)
   - CSRF protection via Passport.js `state` parameter
   - Use HTTPS in production (Secure flag enforced)

4. **Error Handling**:
   - Backend redirects to `/login?error=auth_failed` on OAuth errors
   - Backend redirects to `/login?error=no_email` if Google profile missing email
   - Frontend should parse query params and display appropriate error messages

#### UI/UX Design Guidelines
* **Visual Consistency**: Match the calming, recovery-focused aesthetic from Landing page
* **Color Palette**: Use soft, trustworthy colors (blues, greens, neutrals)
* **Typography**: Clear, readable fonts with adequate spacing
* **Accessibility**: WCAG AA compliance (contrast ratios, keyboard navigation, screen reader support)
* **Mobile-First**: Design for small screens first, then scale up
* **Supportive Language**: Use encouraging, non-judgmental copy (e.g., "Welcome back" vs "Log in")

#### Component Architecture Pattern
```tsx
// Recommended structure for Login.tsx
<div className="min-h-screen flex flex-col">
  <Header />
  <main className="flex-1 flex items-center justify-center">
    <Card className="w-full max-w-md mx-4">
      <CardHeader>
        <CardTitle>Welcome to Reentry Buddy</CardTitle>
        <CardDescription>Sign in to continue your journey</CardDescription>
      </CardHeader>
      <CardContent>
        {error && <Alert variant="destructive">...</Alert>}
        <Button asChild className="w-full">
          <a href="/api/auth/google">
            <ChromeIcon className="mr-2" />
            Sign in with Google
          </a>
        </Button>
      </CardContent>
    </Card>
  </main>
  <Footer />
</div>
```

#### Testing Standards
* **Test Framework**: Vitest + React Testing Library
* **Test File Location**: `client/src/pages/Login.test.tsx` (co-located with component)
* **Test Coverage Requirements**:
  - Unit tests: Component rendering, button behavior, error states
  - Integration tests: Navigation flow, query parameter parsing
  - Accessibility tests: ARIA labels, keyboard navigation
  - Responsive tests: Viewport-specific rendering (optional snapshot tests)
* **Mocking Strategy**:
  - Mock `window.location.href` for navigation tests
  - Mock `useSearchParams` for query parameter tests
  - Use `@testing-library/user-event` for user interaction simulation
* **Test Standards**:
  - Follow AAA pattern (Arrange, Act, Assert)
  - Use semantic queries (`getByRole`, `getByLabelText`) over `getByTestId`
  - Test user-facing behavior, not implementation details
  - Ensure all tests pass before marking story complete

#### Scope Boundaries
* **In Scope**:
  - Refactoring Login.tsx for Google OAuth UI
  - OAuth flow initiation (redirect to backend)
  - Error message display
  - Visual design and responsiveness
  - Unit and integration tests

* **Out of Scope** (Story 1.4):
  - Protected route implementation
  - Logout functionality
  - Global auth state management with `useAuth` hook
  - Automatic redirect for authenticated users
  - Token refresh logic

#### Known Issues from Story 1.2 (Resolved)
- ✅ JWT signature mismatch - Fixed by adding `dotenv.config()` to API handlers
- ✅ Database enum missing 'daily-ritual' - Fixed by migration (commit c2b654c)
- ✅ Placeholder token conflict - Fixed by removing hardcoded token from client

#### Reference Documents
* PRD: `docs/prd/2-requirements.md` (FR1, FR2, NFR1, NFR4, NFR5, NFR6)
* Architecture: `docs/architecture/5-component-architecture.md` (LoginPage component)
* Story 1.2: `docs/stories/1.2.implement-backend-oauth-callback.md` (Backend integration details)

---

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |
| 2025-10-12 | 2.0 | Refined story with comprehensive dev notes, updated acceptance criteria, detailed tasks, testing requirements, and Story 1.2 integration details. Status changed to Approved. | Sarah (Product Owner) |

---

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (2024-10-22)

### Debug Log References
- Testing library dependencies installed: `@testing-library/react`, `@testing-library/user-event`, `@testing-library/jest-dom`
- Vitest configuration updated to include React plugin for proper JSX transformation
- All 19 Login page tests passing successfully

### Completion Notes

**Implementation Summary:**

1. **Login Page Refactor (Task 1)**:
   - Completely replaced email/password form with Google OAuth UI
   - Implemented shadcn/ui Card layout with proper spacing and styling
   - Added Header and Footer components for visual consistency
   - Used Lucide Chrome icon for Google branding
   - Applied `bg-muted/30` background to match Landing page aesthetic
   - Responsive design implemented with `max-w-md` card constraint

2. **OAuth Flow Integration (Task 2)**:
   - Implemented button with `onClick` handler setting `window.location.href`
   - Added loading state with spinner (Loader2 icon) during redirect
   - Button disabled during loading to prevent double-clicks
   - Full page redirect ensures Passport.js middleware handles OAuth

3. **Error Handling (Task 4)**:
   - Implemented `useSearchParams` for query parameter parsing
   - Created `getErrorMessage` function mapping error codes to user-friendly messages
   - Supported error codes: `auth_failed`, `no_email`, `cancelled`, and generic fallback
   - shadcn/ui Alert component with destructive variant for error display
   - Auto-clear error from URL after 5 seconds using useEffect cleanup

4. **Routing Updates (Task 3)**:
   - Verified `/login` route exists in App.tsx
   - Updated Hero component "Get Started" link from `/check-in` to `/login`
   - Navigation flow validated: Landing → Login → OAuth

5. **Comprehensive Testing (Task 5)**:
   - Created `Login.test.tsx` with 19 tests covering all requirements
   - Test categories: Rendering (4), OAuth Flow (3), Error Handling (5), Accessibility (3), Responsive Design (2), Visual Consistency (2)
   - Installed missing testing dependencies
   - Fixed vitest configuration to include React plugin
   - All tests passing (19/19)

**Technical Decisions:**

- Used `useState` for loading state management
- Chose `onClick` with `window.location.href` over anchor tag for better loading state control
- Implemented `useEffect` for automatic error message cleanup
- Used Chrome icon as Google brand representation (simpler than custom SVG)
- Applied ARIA labels for accessibility compliance
- Followed existing component patterns from Landing page

**Visual Design:**

- Calming color scheme consistent with recovery-focused design
- Supportive, non-judgmental copy ("Welcome to Reentry Buddy", "Sign in to continue your recovery journey")
- Clear visual hierarchy with card elevation
- Proper spacing and typography
- Mobile-first responsive design

### File List

**Created:**
- `client/src/pages/Login.test.tsx` - Comprehensive test suite with 19 tests

**Modified:**
- `client/src/pages/Login.tsx` - Complete refactor for Google OAuth UI
- `client/src/components/Hero.tsx` - Updated "Get Started" link to /login
- `vitest.config.ts` - Added React plugin for proper JSX transformation
- `package.json` - Added testing library dependencies
- `docs/stories/1.3.build-frontend-login-ui.md` - Status updated to InProgress, then Ready for Review

---

## QA Results

### Review Date
_To be populated by QA agent_

### Reviewed By
_To be populated by QA agent_

### Code Quality Assessment
_To be populated by QA agent after implementation review_

### Gate Status
_To be populated by QA agent_

---

## Post-QA Approval Checklist

This checklist ensures all steps are completed before marking the story as "Done":

### Code & Documentation
- [ ] All acceptance criteria validated and met
- [ ] All tasks and subtasks completed and checked off
- [ ] File List maintained and accurate
- [ ] Code changes committed to version control
- [ ] No outstanding TODOs or FIXMEs in production code

### Testing & Quality
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] No new errors or warnings introduced
- [ ] Test coverage meets requirements
- [ ] Manual testing completed (cross-browser, responsive design)

### Security & Performance
- [ ] Security review completed
- [ ] No security vulnerabilities identified
- [ ] Performance considerations validated
- [ ] Accessibility standards met (WCAG AA)

### QA Review Artifacts
- [ ] QA Results section completed in story file
- [ ] Quality Gate file created
- [ ] Gate status recorded
- [ ] All QA recommendations addressed

### Deployment Readiness
- [ ] Code follows project coding standards
- [ ] Architecture patterns properly implemented
- [ ] Dependencies properly documented
- [ ] No breaking changes to existing functionality
- [ ] Ready for production deployment

### Communication & Handoff
- [ ] Dev Agent Record completed with all implementation details
- [ ] Change Log updated with version and description
- [ ] Next story dependencies identified (Story 1.4)
- [ ] Handoff notes provided for protected routes implementation

### Final Approval
- [ ] QA Agent review: _PENDING_
- [ ] Quality gate: _PENDING_
- [ ] Deployment readiness: _PENDING_
- [ ] Status update: _PENDING_ (Approved → InProgress → Review → Done)
