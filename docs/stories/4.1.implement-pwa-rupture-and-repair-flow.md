# Story 4.1: Implement PWA Rupture & Repair Flow

### Status
Draft

### Story
As a user who has experienced a relapse, I want to be able to report a 'slip' within the app and receive immediate, compassionate support, so that I can re-engage with my recovery without shame.

### Acceptance Criteria
1. A clearly visible "I slipped" button or link is available in a persistent part of the authenticated UI (e.g., the Header).
2. Clicking the button initiates the Rupture & Repair flow, displayed in a full-screen modal or on a dedicated page.
3. The flow begins by calling a new protected endpoint at `POST /api/repair/start`.
4. On the backend, a new `sessions` record is created with `flowType: 'repair'`.
5. The user's daily streak is gracefully reset.
6. The UI presents the user with an immediate, empathetic message, followed by options to identify a trigger (e.g., "Stress," "People," "Craving").
7. After selecting a trigger, the user is shown a simple, actionable "repair suggestion" based on their selection.
8. The flow concludes with a supportive closing message, and the user is returned to the main dashboard.

### Tasks / Subtasks
- [ ] **Task 1: Backend - Create Repair API Endpoint** (AC: #3, #4, #5)
    - [ ] Create the new API route file `api/repair/start.ts` and protect it with the `requireAuth` middleware.
    - [ ] Implement the backend logic to create a `sessions` record with `flowType: 'repair'`.
    - [ ] Implement the logic to reset the user's streak count.
- [ ] **Task 2: Frontend - Build UI Components** (AC: #1, #2, #6, #7, #8)
    - [ ] Create a new component (e.g., `client/src/components/repair/RepairFlow.tsx`) to manage the state of the multi-step flow.
    - [ ] Add an "I slipped" button to the `Header.tsx` component, visible only to authenticated users.
- [ ] **Task 3: Frontend - Integrate State and API**
    - [ ] Clicking the "I slipped" button should trigger the display of the `RepairFlow` component.
    - [ ] Use TanStack Query's `useMutation` to call the `POST /api/repair/start` endpoint when the flow begins.
    - [ ] After the flow is complete, invalidate the user stats query to refetch the updated (reset) streak.
- [ ] **Task 4: Write Tests**
    - [ ] Write unit tests for the `RepairFlow` component, covering its different steps.
    - [ ] Write integration tests for the `POST /api/repair/start` endpoint to verify session creation and streak reset.

### Dev Notes
* This story implements the critical **F2** feature from the PRD.
* It is dependent on **Epic 1 (Authentication)** being complete.
* The tone and specific wording of the messages are paramount. The content should be sourced from the `docs/front-end-spec.md` and PRD to ensure it is compassionate and non-judgmental.

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |