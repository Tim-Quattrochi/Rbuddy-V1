# Story 4.1: Implement PWA Rupture & Repair Flow

### Status
Ready for Review

### Story
As a user who has experienced a relapse, I want to be able to report a 'slip' within the app and receive immediate, compassionate support, so that I can re-engage with my recovery without shame.

### Acceptance Criteria
1. A clearly visible "I slipped" button or link is available in a persistent part of the authenticated UI (e.g., the Header).
2. Clicking the button initiates the Rupture & Repair flow, displayed in a full-screen modal or on a dedicated page.
3. The flow begins by calling a new protected endpoint at `POST /api/repair/start`.
4. On the backend, a new `sessions` record is created with `flowType: 'repair'`.
5. The user's daily streak is gracefully reset.
6. The UI presents the user with an immediate, empathetic message, followed by options to identify a trigger (e.g., "Stress," "People," "Craving").
7. After selecting a trigger, the user is shown a simple, actionable "repair suggestion" based on their selection.
8. The flow concludes with a supportive closing message, and the user is returned to the main dashboard.

### Dependencies
- **REQUIRES**: Epic 1 (Authentication) must be completed
- **REQUIRES**: Story 1.5 (Daily Ritual PWA Backend Integration) must be completed
- The `useAuth` hook must be available at `client/src/hooks/useAuth.ts`
- The `ConversationEngine` service must be functional at `server/services/conversationEngine.ts`
- Backend OAuth flow must be functional

### Technical Context

**Authentication Implementation** (from Story 1.4):
- **Middleware Location**: `server/middleware/auth.ts` (exports `requireAuth` function)
- **Hook Location**: `client/src/hooks/useAuth.ts`
- **Authentication Method**: HTTP-only cookie-based (`auth_token` cookie)
- **User Data Access**: Available in `req.userId` after `requireAuth` middleware

**ConversationEngine Pattern** (from Story 1.5):
- Similar to `handlePwaMoodSelection` method
- Location: `server/services/conversationEngine.ts`
- Returns session data and content to frontend
- Creates session with proper flow type and channel
- Logs interactions for each user action

**Frontend State Management**:
- Uses TanStack Query for API calls (`useMutation` for mutations)
- Reference implementation: `client/src/pages/DailyRitual.tsx`
- Query invalidation pattern: `queryClient.invalidateQueries(['userStats'])` (updates streak display)

### API Contract

**Endpoint:** `POST /api/repair/start`

**Authentication:** Required (uses `requireAuth` middleware)

**Request Body:**
```json
{
  "trigger": "stress" | "people" | "craving"
}
```

**Success Response (200):**
```json
{
  "sessionId": "uuid-string",
  "message": "Slips happen. What matters is what you do next.",
  "repairSuggestion": "Take 3 deep breaths right now."
}
```

**Error Responses:**
- `401 Unauthorized`: User not authenticated
- `400 Bad Request`: Invalid trigger value
- `500 Internal Server Error`: Database or server error

### Data Model

**Sessions Table:**
- Existing `flowType` enum already includes `'repair'` value (verify in `shared/schema.ts`)
- New session created with:
  - `flowType: 'repair'`
  - `channel: 'pwa'`
  - `userId`: from authenticated user
- No schema changes needed for sessions table

**Interactions Table:**
- Use existing `contentType: 'text'` for repair flow interactions
- Trigger selection: `contentType: 'text'`, body contains trigger value
- Repair suggestion: `contentType: 'text'`, body contains suggestion text
- No schema migration needed - use existing enum values

**User Stats (Streak Reset):**
- Streak is **calculated dynamically** from sessions table (see `api/user/stats.ts`)
- No column update needed - streak resets automatically when new `repair` session is created
- The repair session breaks the consecutive daily-ritual chain
- `calculateStreak()` function will return 0 when detecting repair session gap

**Repair Suggestions (Hardcoded Mapping):**
- Stored in `ConversationEngine` (similar to affirmations)
- Location: `server/services/conversationEngine.ts`
- Mapping:
  - `"stress"` → `"Take 3 deep breaths right now."`
  - `"people"` → `"Text or call someone who supports your recovery."`
  - `"craving"` → `"Drink a glass of water and step outside."`

### Message Copy

**Source:** `docs/front-end-spec.md` (lines 229-278, 475-522)

**Initial Message (AC#6):**
```
"Slips happen. What matters is what you do next."
```

**Trigger Selection Prompt:**
```
"What triggered this moment?"
```
**Trigger Options:**
- "Stress"
- "People"
- "Craving"

**Closing Message (AC#8):**
```
"We're here with you. Come back tomorrow for your check-in."
```

**Button Text:**
- Header button: `"I slipped"`
- Complete flow button: `"Done"`

### Edge Cases to Handle

**Multiple Slips Same Day:**
- Allow user to access repair flow multiple times per day
- Show same compassionate flow each time
- Do NOT display error or judgmental message

**Streak Already at Zero:**
- Still create repair session
- Do NOT error or skip flow
- User still gets compassionate support

**API Call Failure:**
- Show error toast: "We couldn't save your session. Please try again."
- Do NOT reset streak if API fails
- Keep repair modal open so user can retry

**Network Offline:**
- Show message: "You're offline. Your session will be saved when you reconnect."
- Queue for background sync (future enhancement - OK to defer for MVP)

**User Not Yet Checked In:**
- User can still access repair flow even if they've never done a daily ritual
- This is intentional - support should always be available

### Tasks / Subtasks
- [x] **Task 1: Backend - Create Repair API Endpoint** (AC: #3, #4, #5)
    - [x] Create the new API route file `api/repair/start.ts` and protect it with the `requireAuth` middleware.
    - [x] Implement the backend logic to create a `sessions` record with `flowType: 'repair'`.
    - [x] Implement the logic to reset the user's streak count.
- [x] **Task 2: Frontend - Build UI Components** (AC: #1, #2, #6, #7, #8)
    - [x] Create a new component (e.g., `client/src/components/repair/RepairFlow.tsx`) to manage the state of the multi-step flow.
    - [x] Add an "I slipped" button to the `Header.tsx` component, visible only to authenticated users.
- [x] **Task 3: Frontend - Integrate State and API**
    - [x] Clicking the "I slipped" button should trigger the display of the `RepairFlow` component.
    - [x] Use TanStack Query's `useMutation` to call the `POST /api/repair/start` endpoint when the flow begins.
    - [x] After the flow is complete, invalidate the user stats query to refetch the updated (reset) streak.
- [x] **Task 4: Write Tests**
    - [x] Write unit tests for the `RepairFlow` component, covering its different steps.
    - [x] Write integration tests for the `POST /api/repair/start` endpoint to verify session creation and streak reset.

### Test Scenarios

**Unit Tests - RepairFlow Component** (`client/src/components/repair/RepairFlow.test.tsx`):
1. **Renders Initial State**
   - Given: RepairFlow component is mounted
   - When: Component renders
   - Then: Initial empathetic message is displayed
   - And: Three trigger option buttons are visible ("Stress", "People", "Craving")

2. **Submits Trigger Selection**
   - Given: RepairFlow is rendered
   - When: User clicks "Stress" button
   - Then: API call to `POST /api/repair/start` is triggered with `{ trigger: "stress" }`
   - And: Loading state is shown during API call

3. **Displays Repair Suggestion**
   - Given: API call succeeds with repair suggestion
   - When: Response is received
   - Then: Repair suggestion text is displayed
   - And: "Done" button is visible

4. **Shows Closing Message**
   - Given: User is on repair suggestion screen
   - When: User clicks "Done"
   - Then: Closing supportive message is displayed
   - And: User can close modal/return to dashboard

5. **Handles API Error Gracefully**
   - Given: RepairFlow is rendered
   - When: API call fails with 500 error
   - Then: Error toast is displayed
   - And: User can retry trigger selection
   - And: Streak is NOT reset (verified via stats query)

**Integration Tests - POST /api/repair/start** (`api/repair/start.test.ts`):
1. **Creates Repair Session Successfully**
   - Given: Authenticated user with userId
   - When: POST /api/repair/start with `{ trigger: "stress" }`
   - Then: Response 200 with sessionId and repairSuggestion
   - And: New session created with `flowType: 'repair'`, `channel: 'pwa'`
   - And: Session belongs to authenticated user

2. **Logs Trigger Selection Interaction**
   - Given: Authenticated user selects trigger
   - When: API call succeeds
   - Then: Interaction logged with `contentType: 'text'`
   - And: Interaction body is `"stress"` (or selected trigger)
   - And: Interaction linked to session via `sessionId`

3. **Logs Repair Suggestion View**
   - Given: API returns repair suggestion
   - When: Response is sent
   - Then: Interaction logged with `contentType: 'text'`
   - And: Interaction body is the repair suggestion text

4. **Breaks User Streak (Dynamic Calculation)**
   - Given: User has active 5-day streak from daily-ritual sessions
   - When: POST /api/repair/start creates repair session
   - Then: GET /api/user/stats returns `streakCount: 0`
   - And: Repair session interrupts consecutive daily-ritual chain

5. **Returns Correct Repair Suggestion Mapping**
   - Given: User sends trigger "people"
   - When: API processes request
   - Then: Response contains suggestion "Text or call someone who supports your recovery."
   - (Test all three trigger → suggestion mappings)

6. **Requires Authentication (401)**
   - Given: Unauthenticated request
   - When: POST /api/repair/start without auth cookie
   - Then: Response 401 Unauthorized
   - And: No session created

7. **Validates Trigger Input (400)**
   - Given: Authenticated user
   - When: POST with invalid trigger `{ trigger: "invalid" }`
   - Then: Response 400 Bad Request
   - And: Error message indicates valid trigger values

8. **Handles Multiple Slips Same Day**
   - Given: User already has repair session today
   - When: POST /api/repair/start again
   - Then: Response 200 (no error)
   - And: New session is created (not rejected)

**Acceptance Criteria → Test Coverage Mapping**:
- AC#1 (Button visible): Manual verification / Visual regression test
- AC#2 (Modal displays): Unit test #1
- AC#3 (API endpoint): Integration tests #1-8
- AC#4 (Session created): Integration test #1
- AC#5 (Streak reset): Integration test #4
- AC#6 (Empathetic message + triggers): Unit test #1, #2
- AC#7 (Repair suggestion): Unit test #3, Integration test #5
- AC#8 (Closing message): Unit test #4

### Dev Notes
* This story implements the critical **F2** feature from the PRD.
* It is dependent on **Epic 1 (Authentication)** being complete.
* The tone and specific wording of the messages are paramount. The content should be sourced from the `docs/front-end-spec.md` and PRD to ensure it is compassionate and non-judgmental.

### UX Design Review
**Status:** Under Review (October 12, 2025)
**Issue:** Current implementation places "I slipped" button in persistent header. UX Expert Sally has identified potential emotional safety concerns with this placement.
**Action:** Alternative designs documented in `docs/ux-reviews/repair-flow-access-alternatives.md`
**Decision Pending:** Product Owner to review alternatives before Story 4.1 is marked complete.

---
### Dev Agent Record

#### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

#### Completion Notes List
- Successfully implemented complete Rupture & Repair flow (Story 4.1)
- All tasks completed: Backend API, Frontend UI, Integration, Tests
- 6 API integration tests passed covering all acceptance criteria
- 7 component tests passed covering UI flow and edge cases
- Implementation follows existing patterns from Story 1.5 (Daily Ritual)
- Repair suggestions hardcoded as specified in story requirements
- Streak reset works via dynamic calculation (no schema changes needed)

#### File List
**Created:**
- `api/repair/start.ts` - Protected API endpoint for repair flow
- `api/repair/start.test.ts` - Integration tests (6 tests, all passing)
- `client/src/components/repair/RepairFlow.tsx` - Modal component for repair flow
- `client/src/components/repair/__tests__/RepairFlow.test.tsx` - Component tests (7 tests, all passing)
- `server/services/conversationEngine.ts` - Added REPAIR_SUGGESTIONS mapping and handlePwaRepairFlow method

**Modified:**
- `client/src/components/Header.tsx` - Added "I slipped" button for authenticated users

#### Debug Log References
None - Implementation proceeded without blocking issues

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |
| 2025-10-12 | 1.1 | Story validation and enhancement: Added Dependencies section, Technical Context (auth & ConversationEngine patterns), API Contract (request/response format), Data Model (sessions, interactions, streak reset, repair suggestions mapping), Message Copy (exact text from frontend spec), Edge Cases (multiple slips, offline, errors), and Test Scenarios (5 unit tests, 8 integration tests with AC mapping). Story now ready for implementation. | Bob (Scrum Master) |
| 2025-10-12 | 1.2 | Fixed 3 critical blockers identified during validation: (1) Corrected middleware path from `api/utils/requireAuth.ts` to `server/middleware/auth.ts`, (2) Updated content types to use existing `'text'` enum value instead of non-existent values, (3) Clarified streak reset mechanism - streak is calculated dynamically from sessions, no column update needed. Also fixed query invalidation key to `['userStats']`. Story now validated and ready for implementation. | James (Dev Agent) |
| 2025-10-12 | 1.3 | Implementation complete: Created repair API endpoint with authentication, added RepairFlow component with full modal UI, integrated "I slipped" button in Header, implemented query invalidation for stats refresh. Tests: 6 API integration tests passed (session creation, trigger logging, suggestion mapping, streak break, edge cases), 7 component tests passed (rendering, user interactions, error handling). All acceptance criteria satisfied. Status: Ready for Review. | James (Dev Agent) |