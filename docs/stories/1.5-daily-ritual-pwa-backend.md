# Story 1.5: Daily Ritual PWA Backend Integration

### Status
In Progress

### Story
As a user accessing the Daily Ritual via PWA, I want my mood selections and intentions to be saved to the database, so that my progress is tracked and I can see my streak and mood trends.

### Acceptance Criteria
1. When a user selects a mood in the PWA, a new session is created with `flowType: 'daily-ritual'` and `channel: 'pwa'`
2. The mood selection is logged as an `interaction` with `contentType: 'mood_selection'`
3. The affirmation is logged as an `interaction` with `contentType: 'affirmation_view'`
4. The API returns both `sessionId` and `affirmation` to the frontend
5. When a user submits an intention, it's saved to the session and logged as an `interaction` with `contentType: 'intention'`
6. All required enum values exist in the database schema

### Tasks / Subtasks
- [x] **Task 1: Update Database Schema Enums** (AC: #6)
    - [x] Add `'daily-ritual'` to `flow_type` enum
    - [x] Add `'mood_selection'`, `'affirmation_view'`, `'intention'` to `content_type` enum
    - [x] Create and apply database migration
- [x] **Task 2: Implement PWA Mood Selection Handler** (AC: #1, #2, #3, #4)
    - [x] Update `handlePwaMoodSelection` to return session data
    - [x] Create session with proper flow type and channel
    - [x] Log mood selection interaction
    - [x] Log affirmation interaction
    - [x] Return sessionId and affirmation to frontend
- [ ] **Task 3: Implement PWA Intention Handler** (AC: #5)
    - [x] Update session with intention text
    - [x] Log intention interaction
    - [ ] Test intention submission flow
- [ ] **Task 4: Integration Testing**
    - [ ] Test complete flow: mood â†’ affirmation â†’ intention
    - [ ] Verify sessions are created correctly
    - [ ] Verify interactions are logged properly
    - [ ] Verify streak counting works

### Dev Notes
* This story integrates the existing `ConversationEngine` service with the PWA frontend
* Database enum migrations were required because schema definitions (`shared/schema.ts`) were out of sync with actual database
* Future migrations should use `drizzle-kit` workflow (see `docs/MIGRATION-GUIDE.md`)

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-12 | 1.0 | Initial story creation. | Tim |
| 2025-10-12 | 1.1 | Fixed database enum mismatches and updated ConversationEngine return types. | Quinn (QA Agent) |

### Dev Agent Record

#### File List
**Backend Files Modified:**
- `server/services/conversationEngine.ts` (MODIFIED) - Updated `handlePwaMoodSelection` to return session data
- `api/daily-ritual/mood.ts` (EXISTING) - Already properly configured to return JSON response

**Database Migrations Created:**
- `migrations/manual/add-content-type-enum-values.sql` (NEW) - Adds missing content_type enum values
- `migrations/manual/apply-content-type-enum-migration.ts` (NEW) - TypeScript script to apply migration

**Documentation Created:**
- `docs/MIGRATION-GUIDE.md` (NEW) - Best practices for database migrations using drizzle-kit

#### Bugs Fixed
**Bug #1: Empty JSON Response**
- **Issue**: Frontend received "Unexpected end of JSON input" error when selecting mood
- **Root Cause**: `handlePwaMoodSelection` returned `Promise<void>` instead of data
- **Fix**: Changed return type to `Promise<{ sessionId: string; affirmation: string }>` and added return statement
- **Files Changed**: `server/services/conversationEngine.ts:318`

**Bug #2: Database Enum Mismatch**
- **Issue**: Error "invalid input value for enum content_type: 'mood_selection'"
- **Root Cause**: TypeScript schema in `shared/schema.ts` defined enum values that didn't exist in database
- **Fix**: Created and applied SQL migration to add missing enum values
- **Migration**: `migrations/manual/add-content-type-enum-values.sql`
- **Values Added**: `mood_selection`, `affirmation_view`, `intention`

#### Completion Notes
- âœ… Database schema now matches TypeScript definitions
- âœ… PWA mood selection API returns proper JSON response
- âœ… Migration guide created for future database changes
- ðŸ”„ Intention submission needs testing
- ðŸ”„ Full integration testing pending

#### Debug Log References
- Console error: "invalid input value for enum content_type: 'mood_selection'" (resolved)
- Console error: "Failed to execute 'json' on 'Response': Unexpected end of JSON input" (resolved)

---
## QA Results

_Awaiting implementation completion and QA review_

