# Story 1.2 Manual Testing Guide

## Prerequisites
- Ensure `.env` file has the following variables set:
  - `GOOGLE_CLIENT_ID`
  - `GOOGLE_CLIENT_SECRET`
  - `CALLBACK_URL` (e.g., `http://localhost:5001/api/auth/google/callback`)
  - `JWT_SECRET`
  - `DATABASE_URL`
- Google OAuth redirect URIs must be registered in Google Cloud Console

## Manual Testing Steps

### Test 1: OAuth Initiation
1. Start the development server: `npm run dev`
2. Navigate to: `http://localhost:5001/api/auth/google`
3. **Expected**: Browser redirects to Google OAuth consent screen

### Test 2: Successful Authentication - New User
1. Complete OAuth flow by signing in with a Google account (not previously used)
2. **Expected**: 
   - Redirected to `/daily-ritual`
   - `auth_token` cookie is set (check browser DevTools > Application > Cookies)
   - New user record created in database with `googleId`, `email`, and `avatarUrl`.  

### Test 3: Successful Authentication - Existing User
1. Complete OAuth flow with the same Google account
2. **Expected**:
   - Redirected to `/daily-ritual`
   - `auth_token` cookie is set
   - No duplicate user created (same user ID returned)

### Test 4: Cookie Authentication
1. After successful OAuth, make a request to a protected endpoint with the cookie
2. Example: `GET /api/user/stats` (if protected with `requireAuth`)
3. **Expected**: Request succeeds with user authenticated via cookie
4. **Common Issue**: If you see 401 "Invalid or expired token", verify:
   - Cookie `auth_token` exists in browser DevTools > Application > Cookies
   - Cookie domain matches your app domain (e.g., `localhost`)
   - The auth middleware includes manual cookie parsing for Vercel compatibility

### Test 5: Error Handling
1. Attempt to cancel/deny OAuth consent
2. **Expected**: Redirected to `/login?error=no_user`

## Database Verification
```sql
-- Check user was created with OAuth fields
SELECT id, username, email, "googleId", "avatarUrl" 
FROM users 
WHERE "googleId" IS NOT NULL;
```

## Cookie Verification (DevTools)
Check that the `auth_token` cookie has:
- `HttpOnly`: ✓
- `Secure`: ✓ (in production only)
- `SameSite`: Lax
- `Max-Age`: 604800 (7 days)

## Known Issues & Fixes

### Issue: 401 Errors After Successful OAuth (Fixed)
**Symptom**: After successful Google OAuth login, protected routes return 401 "Invalid or expired token"

**Root Cause**: Vercel serverless functions in `api/` directory don't have access to Express middleware stack (including `cookie-parser`). Each serverless function runs in isolation.

**Fix Applied** (Commit f64f0cf): Added manual cookie parsing fallback in `requireAuth` middleware:
```typescript
function parseCookies(cookieHeader: string | undefined): Record<string, string> {
  if (!cookieHeader) return {};
  return cookieHeader.split(';').reduce((cookies, cookie) => {
    const [name, ...rest] = cookie.split('=');
    const value = rest.join('=').trim();
    if (name && value) {
      cookies[name.trim()] = decodeURIComponent(value);
    }
    return cookies;
  }, {} as Record<string, string>);
}
```

The middleware now:
1. Checks `Authorization` header (Bearer token)
2. Checks `req.cookies.auth_token` (if cookie-parser middleware available)
3. **Falls back to manual parsing** of `Cookie` header (for Vercel serverless)

**Verification**: After applying this fix, `/api/user/stats` and other protected routes should work correctly with the JWT cookie set during OAuth.

