### **Story 10: Scheduled Follow-ups**

**User Story:**
As a developer, I need a mechanism to schedule and send automated follow-up messages, so that we can re-engage users and provide timely encouragement, such as after a relapse.

**Story Context:**
*   **Existing System Integration:** This story introduces a new, time-based trigger mechanism to the system using Vercel Cron Jobs. It also requires a new database table.
*   **Technology:** Vercel Cron Jobs, TypeScript, Drizzle ORM, Twilio SDK.
*   **Follows pattern:** Implements a scheduled task processor that reads from a queue-like table (`follow_ups`) and interacts with an external service (Twilio).
*   **Touch points:**
    *   A new `follow_ups` table will be added to `shared/schema.ts`.
    *   A new API route will be created for the cron job, e.g., `api/cron/send-follow-ups.ts`.
    *   The `vercel.json` file will be updated to define the cron schedule.
    *   The `ConversationEngine`'s repair flow will be updated to schedule a follow-up.

**Acceptance Criteria:**
1.  A new `follow_ups` table is created in the database via a Drizzle migration, matching the schema in `docs/architecture/data-models-and-schema-changes.md`.
2.  A Vercel Cron Job is configured in `vercel.json` to run at a regular interval (e.g., every 15 minutes).
3.  The cron job triggers a dedicated API route (`/api/cron/send-follow-ups`).
4.  The API route queries the `follow_ups` table for all records with a `status` of 'pending' and a `scheduledAt` time in the past.
5.  For each pending message found, the handler uses the Twilio SDK to send the specified message to the correct user.
6.  After a message is successfully sent, the `status` of its corresponding record in the `follow_ups` table is updated to 'sent'.
7.  The "SLIP" repair flow (from Story 9) is updated to create a new record in the `follow_ups` table, scheduling a "post_slip_encouragement" message for 24 hours after the SLIP was reported.

**Technical Notes:**
*   **Integration Approach:** The cron handler must be idempotent. Ensure that a message is only sent once, even if the handler runs multiple times on the same pending record. This is typically achieved by updating the record's status in the same transaction or immediately after sending.
*   **Existing Pattern Reference:** This is a new pattern for the application, establishing a foundation for all future scheduled and asynchronous messaging.
*   **Key Constraints:** The cron job's frequency should be chosen carefully to balance responsiveness with cost and system load.

**Definition of Done:**
*   [ ] The `follow_ups` table is created and migrated.
*   [ ] The Vercel Cron Job is configured and successfully triggers the API route on schedule.
*   [ ] Pending messages in the `follow_ups` table are processed and sent.
*   [ ] Reporting a "SLIP" correctly schedules a follow-up message for the following day.
*   [ ] Code has been reviewed and approved by the Architect.
