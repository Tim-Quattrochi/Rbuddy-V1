### **Story 6: Streak Calculation**

**User Story:**
As a returning citizen, I want the system to track my daily check-in streak, so that I can see my progress and feel motivated to continue.

**Story Context:**
*   **Existing System Integration:** This story enhances the `ConversationEngine` by adding logic that reads from the `sessions` table before writing to it.
*   **Technology:** TypeScript, Drizzle ORM, Neon PostgreSQL.
*   **Follows pattern:** Adds business logic to the `ConversationEngine` that depends on historical user data.
*   **Touch points:**
    *   `server/services/conversationEngine.ts` will be modified to include the streak calculation logic.

**Acceptance Criteria:**
1.  Before saving a new session, the `ConversationEngine` queries the `sessions` table for the user's most recent completed session.
2.  If the most recent session occurred on the previous calendar day, the `streakCount` for the new session is set to the previous streak plus one.
3.  If the most recent session occurred before the previous calendar day, the `streakCount` for the new session is reset to 1.
4.  If this is the user's very first session, the `streakCount` is initialized to 1.
5.  The calculated `streakCount` is correctly stored in the `streakCount` column of the new record in the `sessions` table.
6.  The final "ritual complete" message sent to the user is updated to include their current streak (e.g., "Your check-in is complete. You're on a 3-day streak!").

**Technical Notes:**
*   **Integration Approach:** The streak calculation logic should be a private method within the `ConversationEngine`, called before the final `saveSession` operation.
*   **Existing Pattern Reference:** This story will involve querying the database using the Drizzle client, similar to patterns that might exist elsewhere in the codebase for reading data.
*   **Key Constraints:** Date and timezone calculations must be handled carefully to accurately determine what constitutes a "previous calendar day." The logic should be robust against multiple check-ins on the same day.

**Definition of Done:**
*   [ ] The `streakCount` is correctly calculated and saved with each new session.
*   [ ] The streak correctly resets to 1 after a user misses one or more days.
*   [ ] The user is informed of their current streak in the completion message.
*   [ ] Unit tests for the streak calculation logic (covering new streaks, continued streaks, and broken streaks) pass.
*   [ ] Code has been reviewed and approved by the Architect.
