# Story 3.1: Integrate useAuth Hook into Daily Ritual

### Status
done

### Story
As an authenticated user, I want the Daily Ritual page to display my user context and handle authentication state properly, so that I have a seamless and personalized check-in experience.

### Dependencies
- **REQUIRES**: Story 1.4 (Implement Protected Routes and Logout) must be completed
- The `useAuth` hook must be available at `client/src/hooks/useAuth.ts`
- Backend OAuth flow must be functional
- Daily Ritual API endpoints must be deployed and tested

### Technical Context

**Authentication Implementation** (from Story 1.4):
- **Hook Location**: `client/src/hooks/useAuth.ts`
- **Hook Interface**:
  ```typescript
  {
    user: User | null,              // Current user object or null if not authenticated
    isAuthenticated: boolean,        // True if user is logged in
    isLoading: boolean,              // True while fetching user data
    error: Error | null,             // Any error from fetching user
    logout: () => void,              // Function to log out user
    isLoggingOut: boolean,           // True while logout is in progress
    refetch: () => void              // Function to manually refetch user data
  }
  ```
- **User Type**:
  ```typescript
  {
    id: string,
    username: string,
    email: string,
    googleId?: string,
    avatarUrl?: string,
    phoneNumber?: string
  }
  ```

**Authentication Method**:
- Uses HTTP-only cookie-based authentication (`auth_token` cookie set by OAuth)
- **NO Authorization headers needed** - cookies are sent automatically with `credentials: 'include'`
- All existing API calls in `DailyRitual.tsx` already use `credentials: 'include'` correctly

**Current State**:
- `DailyRitual.tsx` correctly implements cookie-based auth for all API calls
- Backend endpoints (`/api/user/stats`, `/api/daily-ritual/mood`, `/api/daily-ritual/intention`) are functional
- Missing: Integration of `useAuth` hook to display user context and handle auth edge cases

### Acceptance Criteria
1. The `useAuth` hook is imported and used in `DailyRitual.tsx`
2. While `useAuth.isLoading` is true, a loading indicator is displayed
3. If user is not authenticated (`!isAuthenticated`), appropriate feedback is shown (the ProtectedRoute component should handle redirects, but graceful UI handling is preferred)
4. When an authenticated user loads the `/daily-ritual` page, the API call to `GET /api/user/stats` succeeds, and their correct streak count is displayed
5. When the user clicks a mood button, the `POST /api/daily-ritual/mood` call succeeds, and the corresponding affirmation is displayed
6. A new `sessions` record is created in the database for the user's check-in
7. When the user submits an optional intention, the `POST /api/daily-ritual/intention` call succeeds, and the `sessions` record is updated
8. The page correctly handles and displays loading states while fetching data and submitting mutations
9. User-facing error messages are displayed if an API call fails
10. (Optional) User's email or username is displayed in the page header for personalization

### Tasks / Subtasks
- [x] **Task 1: Backend Verification**
    - [x] Verify that `/api/user/stats` endpoint returns correct streak count for authenticated users
    - [x] Verify that `/api/daily-ritual/mood` endpoint creates a new session and returns sessionId and affirmation
    - [x] Verify that `/api/daily-ritual/intention` endpoint updates the session with intention text
    - [x] Test all endpoints with valid authentication cookies to ensure they work end-to-end
    - [x] Confirm database writes are successful by checking the `sessions` table after API calls

- [x] **Task 2: Frontend useAuth Integration**
    - [x] Import `useAuth` hook in `client/src/pages/DailyRitual.tsx`
    - [x] Destructure necessary values: `{ user, isAuthenticated, isLoading }`
    - [x] Add loading state UI while `isLoading` is true (before stats query runs)
    - [x] Add fallback UI or message if `!isAuthenticated` (belt-and-suspenders - ProtectedRoute should prevent this)
    - [x] (Optional) Display user's email or username in page header for personalization
    - [x] Verify all existing API fetch calls continue to work (they should - no changes needed to fetch logic)
    - [x] Test authentication error scenarios (expired session, invalid cookie, etc.)

- [x] **Task 3: Integration Testing**
    - [x] Create integration test file: `client/src/pages/__tests__/DailyRitual.integration.test.tsx`
    - [x] **Test Scenario 1**: Authenticated user loads page and sees streak counter
      - Mock `useAuth` to return authenticated user
      - Mock `GET /api/user/stats` to return `{ streakCount: 5 }`
      - Assert StreakCounter displays "5 Days"
    - [x] **Test Scenario 2**: User selects mood and sees affirmation
      - Mock `POST /api/daily-ritual/mood` to return `{ sessionId: '123', affirmation: 'Test' }`
      - Simulate mood button click
      - Assert affirmation card appears with correct text
    - [x] **Test Scenario 3**: User submits intention and sees success toast
      - Mock `POST /api/daily-ritual/intention` to return success
      - Simulate intention input and submit
      - Assert success toast appears
    - [x] **Test Scenario 4**: API error displays error message
      - Mock API call to fail with 500 error
      - Assert error alert is displayed with retry button
    - [x] **Test Scenario 5**: Loading states render correctly
      - Mock delayed API responses
      - Assert loading indicators appear while pending
    - [x] Reference existing test patterns in `client/src/components/daily-ritual/__tests__/StreakCounter.test.tsx`

### References
- **useAuth Hook Implementation**: `client/src/hooks/useAuth.ts`
- **Story 1.4**: Protected Routes and Logout (prerequisite)
- **Architecture - API Design**: `docs/architecture/6-api-design-and-integration.md#daily-ritual-endpoints`
- **Architecture - Testing Standards**: `docs/architecture/10-coding-standards-testing-and-security.md#testing-approach`
- **Database Schema**: `shared/schema.ts` (sessions table structure)
- **Existing Component Tests**: `client/src/components/daily-ritual/__tests__/` (for test pattern reference)

### Dev Notes
* This story integrates the `useAuth` hook to provide user context and improve authentication state handling
* All authentication infrastructure from Epic 1 is complete and functional
* The current implementation already uses cookie-based auth correctly - no changes to fetch logic needed
* Focus on enhancing UX by displaying user info and handling edge cases gracefully
* The ProtectedRoute wrapper (from Story 1.4) already handles redirect logic, but we add defensive checks for robustness

### Edge Cases to Consider
1. **Session Expiration**: If the auth cookie expires mid-ritual, API calls will fail with 401. Consider showing a "session expired" message and logout button.
2. **Network Errors**: Distinguish between auth errors (401) and other errors (500, network issues) in error messages.
3. **Concurrent Sessions**: If user opens multiple tabs, ensure state remains consistent.
4. **Incomplete Rituals**: If user navigates away mid-ritual, ensure partial data is handled correctly on return.

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |
| 2025-10-12 | 2.0 | Complete revision after validation - updated to reflect actual codebase state, corrected authentication approach, added useAuth integration details, expanded testing guidance. | Scrum Master (Bob) |
| 2025-10-12 | 3.0 | Story completed. Integrated useAuth hook into DailyRitual page, added authentication state handling, user personalization, comprehensive integration tests (9 tests passing), and end-to-end verification. All acceptance criteria met. | Developer |

---
## QA Results

### Review Date: October 12, 2025

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: EXCELLENT** ✅

This story demonstrates outstanding implementation quality with comprehensive test coverage, proper authentication integration, and excellent user experience enhancements. The developer successfully integrated the `useAuth` hook while maintaining clean architecture and following React/TypeScript best practices.

**Key Strengths:**
- ✅ Proper useAuth hook integration with defensive authentication checks
- ✅ Enhanced error handling that distinguishes between 401 (session expired) and other errors
- ✅ User personalization with welcome message displaying username/email
- ✅ Comprehensive loading states at each async operation stage
- ✅ Belt-and-suspenders security approach with multiple authentication safeguards
- ✅ Excellent test coverage: 9 integration tests, all passing (100%)
- ✅ Cookie-based authentication correctly maintained throughout
- ✅ Optimistic updates for improved user experience

**Code Review Highlights:**
- Clean component structure with proper separation of concerns
- Type-safe implementation with TypeScript strict mode
- User-friendly error messages with actionable feedback
- Efficient use of React Query with proper cache invalidation
- No unnecessary API calls (stats query disabled when not authenticated)

### Refactoring Performed

**No refactoring needed** - The code quality is already at production standards. The implementation is clean, well-tested, maintainable, and follows all project conventions.

### Compliance Check

- **Coding Standards**: ✅ PASS
  - TypeScript strict mode compliance
  - Proper async/await patterns
  - Consistent naming conventions
  - Clean component structure

- **Project Structure**: ✅ PASS
  - Tests properly co-located in `__tests__/` directory
  - Integration tests follow existing patterns
  - Proper use of shared types from `@shared/schema`

- **Testing Strategy**: ✅ PASS
  - Comprehensive integration tests (9 tests covering all scenarios)
  - Proper mocking of useAuth and fetch
  - Tests verify both happy paths and error scenarios
  - Loading states and edge cases tested

- **All ACs Met**: ✅ PASS
  - AC1-10: All acceptance criteria fully implemented and verified
  - Complete requirements traceability from AC to test coverage
  - No gaps in functionality

### Improvements Checklist

**Completed by Developer:**
- [x] Integrated useAuth hook with proper state management
- [x] Added loading state UI during authentication check
- [x] Added fallback UI for unauthenticated state
- [x] Enhanced error handling with 401 detection and user-friendly messages
- [x] Added user personalization (welcome message with username/email)
- [x] Created comprehensive integration test suite (9 tests, all passing)
- [x] Verified all existing API calls continue to work correctly
- [x] Tested authentication error scenarios (expired session, network errors)
- [x] Updated story documentation to Complete status
- [x] All tasks and acceptance criteria met

**Optional Future Enhancements (Not Blocking):**
- [ ] Fix TypeScript warning in test file: `global.fetch = fetchMock as any;` (line 53)
- [ ] Add E2E tests with Playwright/Cypress for complete user journey validation
- [ ] Consider adding retry logic with exponential backoff for transient network errors
- [ ] Add analytics tracking for ritual completion rates and user engagement metrics

### Security Review

**Status: PASS** ✅

**Authentication & Authorization:**
- ✅ Cookie-based auth correctly maintained (no unnecessary header changes)
- ✅ No hardcoded credentials or tokens in code
- ✅ Session expiration properly handled with clear user feedback
- ✅ Authentication state checked before making API calls (enabled flag on stats query)
- ✅ Multiple layers of auth checking (useAuth + ProtectedRoute + backend middleware)

**Input Validation & Error Handling:**
- ✅ Proper error boundaries with user-friendly messages
- ✅ 401 errors explicitly detected and handled with session expired messaging
- ✅ Network errors vs auth errors properly distinguished
- ✅ No sensitive information exposed in error messages

**Potential Considerations (Low Priority):**
- No security issues identified for MVP release
- Consider adding rate limiting monitoring on frontend for future releases

### Performance Considerations

**Status: PASS** ✅

**Efficiency Improvements:**
- ✅ `enabled: isAuthenticated` prevents unnecessary API calls when user not logged in
- ✅ React Query caching with 5-minute stale time reduces redundant requests
- ✅ Optimistic updates provide instant UI feedback during mutations
- ✅ Proper query invalidation ensures data consistency

**Test Performance:**
- ✅ Test suite executes in 738ms (excellent)
- ✅ No flaky tests or timing issues detected
- ✅ Proper cleanup prevents memory leaks

**Recommendations:**
- Current performance is excellent for production deployment
- Monitor query response times in production
- Consider adding performance budgets for future features

### Requirements Traceability

**Given-When-Then Mapping:**

**AC1: useAuth Hook Integration**
- **Given** the Daily Ritual page is loaded
- **When** the component mounts
- **Then** the useAuth hook is imported and called
- **Test Coverage:** ✅ All integration tests use mocked useAuth

**AC2: Loading State During Auth Check**
- **Given** useAuth is fetching user data
- **When** isLoading is true
- **Then** a loading indicator is displayed
- **Test Coverage:** ✅ "shows loading state while authentication is being checked"

**AC3: Unauthenticated User Feedback**
- **Given** user is not authenticated
- **When** isAuthenticated is false
- **Then** appropriate feedback is shown
- **Test Coverage:** ✅ "shows authentication required message if user is not authenticated"

**AC4: Stats Display for Authenticated User**
- **Given** user is authenticated
- **When** /api/user/stats is called
- **Then** correct streak count is displayed
- **Test Coverage:** ✅ "displays user welcome message and streak counter"

**AC5: Mood Selection Success**
- **Given** user clicks a mood button
- **When** POST /api/daily-ritual/mood succeeds
- **Then** corresponding affirmation is displayed
- **Test Coverage:** ✅ "displays affirmation after mood selection"

**AC6: Session Creation**
- **Given** user selects a mood
- **When** the mood is processed
- **Then** a new sessions record is created in database
- **Test Coverage:** ✅ Verified in backend Story 1.5 integration tests

**AC7: Intention Submission**
- **Given** user submits an intention
- **When** POST /api/daily-ritual/intention succeeds
- **Then** sessions record is updated
- **Test Coverage:** ✅ "saves intention and shows success message"

**AC8: Loading States Display**
- **Given** async operations are in progress
- **When** data is being fetched or submitted
- **Then** loading indicators are shown
- **Test Coverage:** ✅ "shows loading indicator while fetching stats" + "shows loading indicator while posting mood"

**AC9: Error Messages Display**
- **Given** an API call fails
- **When** the error is caught
- **Then** user-facing error message is displayed
- **Test Coverage:** ✅ "displays error alert when mood selection fails" + "displays session expired message for 401 errors"

**AC10: User Personalization**
- **Given** user is authenticated
- **When** the page loads
- **Then** user's email or username is displayed in header
- **Test Coverage:** ✅ "displays user welcome message and streak counter" (verifies welcome text)

**Coverage Gaps:** NONE - All acceptance criteria have corresponding test coverage ✅

### Testability Evaluation

**Controllability: EXCELLENT** ✅
- Can control authentication state via useAuth mock
- Can control API responses via fetch mock
- Can simulate all user interactions (clicks, typing, blur)
- Can control timing of async operations

**Observability: EXCELLENT** ✅
- All UI states are observable via screen queries
- Toast notifications can be verified
- Loading states are explicitly rendered and testable
- Error messages are displayed and verifiable

**Debuggability: EXCELLENT** ✅
- Clear error messages with context
- Tests have descriptive names and assertions
- Test failures would be easy to diagnose
- Mock implementations are straightforward

### Technical Debt Identification

**Current Debt: MINIMAL** ✅

**Minor Items (Not Blocking):**

1. **TypeScript Warning in Test File**
   - Location: `client/src/pages/__tests__/DailyRitual.integration.test.tsx:53`
   - Issue: Type mismatch on `global.fetch = fetchMock`
   - Impact: Low (tests run successfully, just a type warning)
   - Fix: Add type assertion: `global.fetch = fetchMock as any;`
   - Effort: 1 minute

2. **No E2E Tests Yet**
   - Integration tests cover component behavior well
   - Future: Add Playwright/Cypress tests for full user journey
   - Impact: Low (adequate coverage for MVP)
   - Priority: Future sprint

**Recommendation:** The identified items are minor and do not block production deployment. Address the TypeScript warning when convenient, and plan E2E tests for future sprint.

### Files Modified During Review

**No files modified during review** - The code quality was already at production standards.

### Gate Status

Gate: **PASS** → `docs/qa/gates/3.1-integrate-useauth-daily-ritual.yml`  
Quality Score: **95/100**  
Risk Profile: LOW

### Recommended Status

✅ **Ready for Done**

This story is production-ready and exemplifies excellent engineering practices:

**Achievements:**
- Complete feature implementation with all 10 acceptance criteria met
- Comprehensive test coverage (9 integration tests, 100% passing)
- Proper authentication state management with defensive coding
- Enhanced user experience with personalization and clear error handling
- Clean, maintainable code following project standards
- No security vulnerabilities identified
- Excellent performance characteristics

**Quality Indicators:**
- Test suite: 9/9 passing ✅
- Code review: No issues found ✅
- Security review: PASS ✅
- Performance: Excellent ✅
- Requirements coverage: 100% ✅

**Next Steps:**
1. Merge PR#9 into main branch
2. Mark Story 3.1 as "Done"
3. (Optional) Address TypeScript warning in future cleanup
4. Monitor authentication flows in production

**Confidence Level**: HIGH ✅  
**Production Ready**: YES ✅

---

**Review Completed**: October 12, 2025  
**Reviewer**: Quinn (Test Architect & Quality Advisor)  
**PR Reviewed**: #9 - feat: integrate useAuth hook into Daily Ritual page