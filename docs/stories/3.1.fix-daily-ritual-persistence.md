# Story 3.1: Integrate useAuth Hook into Daily Ritual

### Status
Complete

### Story
As an authenticated user, I want the Daily Ritual page to display my user context and handle authentication state properly, so that I have a seamless and personalized check-in experience.

### Dependencies
- **REQUIRES**: Story 1.4 (Implement Protected Routes and Logout) must be completed
- The `useAuth` hook must be available at `client/src/hooks/useAuth.ts`
- Backend OAuth flow must be functional
- Daily Ritual API endpoints must be deployed and tested

### Technical Context

**Authentication Implementation** (from Story 1.4):
- **Hook Location**: `client/src/hooks/useAuth.ts`
- **Hook Interface**:
  ```typescript
  {
    user: User | null,              // Current user object or null if not authenticated
    isAuthenticated: boolean,        // True if user is logged in
    isLoading: boolean,              // True while fetching user data
    error: Error | null,             // Any error from fetching user
    logout: () => void,              // Function to log out user
    isLoggingOut: boolean,           // True while logout is in progress
    refetch: () => void              // Function to manually refetch user data
  }
  ```
- **User Type**:
  ```typescript
  {
    id: string,
    username: string,
    email: string,
    googleId?: string,
    avatarUrl?: string,
    phoneNumber?: string
  }
  ```

**Authentication Method**:
- Uses HTTP-only cookie-based authentication (`auth_token` cookie set by OAuth)
- **NO Authorization headers needed** - cookies are sent automatically with `credentials: 'include'`
- All existing API calls in `DailyRitual.tsx` already use `credentials: 'include'` correctly

**Current State**:
- `DailyRitual.tsx` correctly implements cookie-based auth for all API calls
- Backend endpoints (`/api/user/stats`, `/api/daily-ritual/mood`, `/api/daily-ritual/intention`) are functional
- Missing: Integration of `useAuth` hook to display user context and handle auth edge cases

### Acceptance Criteria
1. The `useAuth` hook is imported and used in `DailyRitual.tsx`
2. While `useAuth.isLoading` is true, a loading indicator is displayed
3. If user is not authenticated (`!isAuthenticated`), appropriate feedback is shown (the ProtectedRoute component should handle redirects, but graceful UI handling is preferred)
4. When an authenticated user loads the `/daily-ritual` page, the API call to `GET /api/user/stats` succeeds, and their correct streak count is displayed
5. When the user clicks a mood button, the `POST /api/daily-ritual/mood` call succeeds, and the corresponding affirmation is displayed
6. A new `sessions` record is created in the database for the user's check-in
7. When the user submits an optional intention, the `POST /api/daily-ritual/intention` call succeeds, and the `sessions` record is updated
8. The page correctly handles and displays loading states while fetching data and submitting mutations
9. User-facing error messages are displayed if an API call fails
10. (Optional) User's email or username is displayed in the page header for personalization

### Tasks / Subtasks
- [x] **Task 1: Backend Verification**
    - [x] Verify that `/api/user/stats` endpoint returns correct streak count for authenticated users
    - [x] Verify that `/api/daily-ritual/mood` endpoint creates a new session and returns sessionId and affirmation
    - [x] Verify that `/api/daily-ritual/intention` endpoint updates the session with intention text
    - [x] Test all endpoints with valid authentication cookies to ensure they work end-to-end
    - [x] Confirm database writes are successful by checking the `sessions` table after API calls

- [x] **Task 2: Frontend useAuth Integration**
    - [x] Import `useAuth` hook in `client/src/pages/DailyRitual.tsx`
    - [x] Destructure necessary values: `{ user, isAuthenticated, isLoading }`
    - [x] Add loading state UI while `isLoading` is true (before stats query runs)
    - [x] Add fallback UI or message if `!isAuthenticated` (belt-and-suspenders - ProtectedRoute should prevent this)
    - [x] (Optional) Display user's email or username in page header for personalization
    - [x] Verify all existing API fetch calls continue to work (they should - no changes needed to fetch logic)
    - [x] Test authentication error scenarios (expired session, invalid cookie, etc.)

- [x] **Task 3: Integration Testing**
    - [x] Create integration test file: `client/src/pages/__tests__/DailyRitual.integration.test.tsx`
    - [x] **Test Scenario 1**: Authenticated user loads page and sees streak counter
      - Mock `useAuth` to return authenticated user
      - Mock `GET /api/user/stats` to return `{ streakCount: 5 }`
      - Assert StreakCounter displays "5 Days"
    - [x] **Test Scenario 2**: User selects mood and sees affirmation
      - Mock `POST /api/daily-ritual/mood` to return `{ sessionId: '123', affirmation: 'Test' }`
      - Simulate mood button click
      - Assert affirmation card appears with correct text
    - [x] **Test Scenario 3**: User submits intention and sees success toast
      - Mock `POST /api/daily-ritual/intention` to return success
      - Simulate intention input and submit
      - Assert success toast appears
    - [x] **Test Scenario 4**: API error displays error message
      - Mock API call to fail with 500 error
      - Assert error alert is displayed with retry button
    - [x] **Test Scenario 5**: Loading states render correctly
      - Mock delayed API responses
      - Assert loading indicators appear while pending
    - [x] Reference existing test patterns in `client/src/components/daily-ritual/__tests__/StreakCounter.test.tsx`

### References
- **useAuth Hook Implementation**: `client/src/hooks/useAuth.ts`
- **Story 1.4**: Protected Routes and Logout (prerequisite)
- **Architecture - API Design**: `docs/architecture/6-api-design-and-integration.md#daily-ritual-endpoints`
- **Architecture - Testing Standards**: `docs/architecture/10-coding-standards-testing-and-security.md#testing-approach`
- **Database Schema**: `shared/schema.ts` (sessions table structure)
- **Existing Component Tests**: `client/src/components/daily-ritual/__tests__/` (for test pattern reference)

### Dev Notes
* This story integrates the `useAuth` hook to provide user context and improve authentication state handling
* All authentication infrastructure from Epic 1 is complete and functional
* The current implementation already uses cookie-based auth correctly - no changes to fetch logic needed
* Focus on enhancing UX by displaying user info and handling edge cases gracefully
* The ProtectedRoute wrapper (from Story 1.4) already handles redirect logic, but we add defensive checks for robustness

### Edge Cases to Consider
1. **Session Expiration**: If the auth cookie expires mid-ritual, API calls will fail with 401. Consider showing a "session expired" message and logout button.
2. **Network Errors**: Distinguish between auth errors (401) and other errors (500, network issues) in error messages.
3. **Concurrent Sessions**: If user opens multiple tabs, ensure state remains consistent.
4. **Incomplete Rituals**: If user navigates away mid-ritual, ensure partial data is handled correctly on return.

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |
| 2025-10-12 | 2.0 | Complete revision after validation - updated to reflect actual codebase state, corrected authentication approach, added useAuth integration details, expanded testing guidance. | Scrum Master (Bob) |
| 2025-10-12 | 3.0 | Story completed. Integrated useAuth hook into DailyRitual page, added authentication state handling, user personalization, comprehensive integration tests (9 tests passing), and end-to-end verification. All acceptance criteria met. | Developer |