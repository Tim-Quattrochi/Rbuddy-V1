### **Story 8: IVR DTMF Input**

**User Story:**
As a user on a voice call, I want to be able to press a number on my keypad to select my mood, so that the system can recognize my choice and I can proceed with my check-in.

**Story Context:**
*   **Existing System Integration:** This story connects the IVR flow to the `ConversationEngine`. It involves creating a new webhook to handle the `<Gather>` action from the previous story.
*   **Technology:** Vercel Serverless Functions, TypeScript, Twilio, Drizzle ORM.
*   **Follows pattern:** Extends the `ConversationEngine` to be channel-aware (handling both 'sms' and 'ivr').
*   **Touch points:**
    *   A new file will be created at `api/webhooks/twilio/voice/gather.ts`.
    *   `server/services/conversationEngine.ts` will be updated to handle the 'ivr' channel and process DTMF input.

**Acceptance Criteria:**
1.  A new Vercel API route is created at `/api/webhooks/twilio/voice/gather`.
2.  This handler correctly receives the `Digits` parameter (the number the user pressed) from the Twilio request.
3.  The `ConversationEngine.processInput()` method is updated to accept a `channel` parameter ('sms' or 'ivr').
4.  The `gather` webhook calls the `ConversationEngine`, passing the user's phone number, the captured `Digits` as the input, and 'ivr' as the channel.
5.  The `ConversationEngine` processes the mood selection and transitions to the affirmation step.
6.  The `gather` webhook receives the affirmation text from the `ConversationEngine` and uses TwiML's `<Say>` verb to read it back to the user.
7.  For this story, after reading the affirmation, the TwiML response uses the `<Hangup/>` verb to gracefully end the call.
8.  The user's session is successfully logged to the `sessions` table with the `channel` set to 'ivr'.

**Technical Notes:**
*   **Integration Approach:** The core FSM logic in the `ConversationEngine` should be reused. The primary change is adapting the input/output to handle DTMF digits and TwiML instead of SMS text.
*   **Existing Pattern Reference:** The `ConversationEngine`'s role as the central state machine remains the same.
*   **Key Constraints:** The `ConversationEngine` should remain agnostic to the specific TwiML verbs. It should process data and return text responses, leaving the `gather` handler to generate the appropriate TwiML.

**Definition of Done:**
*   [ ] When a user calls, they are prompted for their mood, and their keypress is correctly processed.
*   [ ] The system reads back the correct affirmation and then ends the call.
*   [ ] A new session is logged to the database with the channel correctly marked as 'ivr'.
*   [ ] Unit tests for the 'ivr' channel logic within the `ConversationEngine` pass.
*   [ ] Code has been reviewed and approved by the Architect.
