# Story 4.1B: AI-Powered Repair Suggestions (Frontend)

### Status
Draft

### Story
**As a** user experiencing a trigger in the repair flow,  
**I want** to see AI-generated personalized suggestions with a clear loading state,  
**so that** I understand the system is thinking about my unique situation and know when my response is ready.

### Acceptance Criteria
1. When user selects a trigger, a loading state is displayed while AI generates the response
2. Loading state shows compassionate message (e.g., "Finding the right support for you...")
3. Once AI response is ready, it displays in the existing repair suggestion UI
4. If AI response is longer than hardcoded suggestions, the UI adapts (scrollable if needed)
5. SAMHSA hotline number (1-800-662-4357) is prominently displayed or highlighted in the AI response
6. If AI call fails and fallback is returned, user sees the same compassionate experience (no error message)
7. All existing repair flow component tests continue to pass with updated AI behavior
8. Loading state includes skeleton UI or spinner for better UX

### Dependencies
- **REQUIRES**: Story 4.1A (AI-Powered Repair Suggestions - Backend) must be completed
- **REQUIRES**: Story 4.1 (Implement PWA Rupture & Repair Flow) must be completed
- Existing `RepairFlow` component at `client/src/components/repair/RepairFlow.tsx`
- Existing `POST /api/repair/start` endpoint (updated in Story 4.1A)

### Technical Context

**Current Frontend Implementation** (from Story 4.1):
- **Component**: `client/src/components/repair/RepairFlow.tsx`
- **Flow**: 3 steps (trigger selection → suggestion display → closing message)
- **State Management**: useState for step navigation
- **API Integration**: TanStack Query `useMutation` for `POST /api/repair/start`
- **Loading State**: Currently shows generic "Loading..." during API call
- **Tests**: 10 component tests passing (all rendering, interaction, error handling)

**Changes from Story 4.1A (Backend)**:
- API response now contains AI-generated text (longer, more detailed)
- Response may be 150-300 words vs. previous 5-15 words
- Response includes SAMHSA hotline reference
- API call may take 2-5 seconds (AI processing time) vs. <100ms before
- Fallback response returned if AI fails (user shouldn't notice difference)

**UI/UX Considerations**:
- Longer loading time (2-5 seconds) requires better loading state
- Longer response text requires scrollable container
- SAMHSA hotline should be visually prominent (bold, larger text, or button)
- Loading message should be compassionate and reassuring
- No error messages if AI fails (fallback is seamless)

### UI Design Specifications

**Loading State Enhancement**:

**Current** (Story 4.1):
```tsx
{repairMutation.isPending && (
  <p className="text-center text-muted-foreground">Loading...</p>
)}
```

**Enhanced** (Story 4.1B):
```tsx
{repairMutation.isPending && (
  <div className="space-y-3 text-center">
    <div className="flex justify-center">
      <Loader2 className="h-8 w-8 animate-spin text-purple-500" />
    </div>
    <p className="text-muted-foreground">
      Finding the right support for you...
    </p>
    <p className="text-sm text-muted-foreground/70">
      This may take a moment
    </p>
  </div>
)}
```

**Suggestion Display Enhancement**:

**Current** (Story 4.1):
```tsx
<CardContent className="space-y-4">
  <p className="text-center text-foreground">
    {repairData.repairSuggestion}
  </p>
  <Button className="w-full" onClick={handleContinue}>
    Continue
  </Button>
</CardContent>
```

**Enhanced** (Story 4.1B):
```tsx
<CardContent className="space-y-4">
  <div className="max-h-[400px] overflow-y-auto space-y-4 p-4 bg-muted/30 rounded-lg">
    <p className="text-foreground leading-relaxed">
      {repairData.repairSuggestion}
    </p>
  </div>
  
  {/* SAMHSA Hotline Highlight (if included in AI response) */}
  {repairData.repairSuggestion.includes('1-800-662-4357') && (
    <div className="flex items-center justify-center gap-2 p-3 bg-purple-50 border border-purple-200 rounded-lg">
      <Phone className="h-5 w-5 text-purple-600" />
      <a 
        href="tel:1-800-662-4357"
        className="text-purple-700 font-semibold hover:underline"
      >
        Call SAMHSA: 1-800-662-4357
      </a>
    </div>
  )}

  <Button className="w-full" onClick={handleContinue}>
    Continue
  </Button>
</CardContent>
```

**Alternative: SAMHSA Regex Extraction**:
```tsx
// Extract and highlight SAMHSA hotline from AI response
const samhsaMatch = repairData.repairSuggestion.match(/1-800-662-4357|SAMHSA National Helpline/i);
const suggestionWithoutHotline = repairData.repairSuggestion.replace(/Call SAMHSA.*?\./gi, '').trim();
```

### Component Changes

**File to Modify**: `client/src/components/repair/RepairFlow.tsx`

**Changes Required**:

1. **Import Additional Icons** (for loading and phone):
```tsx
import { X, Loader2, Phone } from "lucide-react";
```

2. **Enhanced Loading State** (replace existing loading UI):
- Add spinner with animation
- Add compassionate loading message
- Add secondary "this may take a moment" text

3. **Scrollable Suggestion Container**:
- Add max-height and overflow-y-auto
- Add padding and background for readability
- Ensure mobile-responsive

4. **SAMHSA Hotline Highlight** (conditional rendering):
- Check if response includes SAMHSA number
- Display prominent call-to-action button/link
- Use tel: protocol for mobile click-to-call

5. **Error Handling** (no visible changes):
- Backend returns fallback response if AI fails
- Frontend treats fallback same as AI response
- User experience is seamless (no error toast for AI failure)

### Edge Cases to Handle

**Long AI Response (>300 words)**:
- Scrollable container handles overflow
- Mobile UX: Full-screen modal with scroll
- No truncation (user can read full response)

**Very Short Fallback Response**:
- UI handles short text without awkward spacing
- SAMHSA highlight still shows if present

**Slow AI Response (5+ seconds)**:
- Loading state reassures user ("Finding the right support...")
- No timeout error (backend handles timeout and returns fallback)
- User can close modal during loading (cancel mutation)

**SAMHSA Hotline Not Detected**:
- If regex doesn't match, don't show highlight
- Response still displays normally
- Backend validation should prevent this (AC from 4.1A)

**Mobile Responsiveness**:
- Modal remains full-screen on mobile
- Scrollable content works with touch gestures
- Phone number is tappable (tel: link works)

### Tasks / Subtasks

- [ ] **Task 1: Enhance Loading State** (AC: #1, #2, #8)
  - [ ] Import `Loader2` icon from lucide-react
  - [ ] Replace existing loading text with spinner + compassionate message
  - [ ] Add "This may take a moment" secondary text
  - [ ] Test loading state displays correctly during API call

- [ ] **Task 2: Make Suggestion Display Scrollable** (AC: #3, #4)
  - [ ] Wrap suggestion text in scrollable container
  - [ ] Add `max-h-[400px] overflow-y-auto` styles
  - [ ] Add padding and background for readability
  - [ ] Test with long AI response (mock 300-word text)

- [ ] **Task 3: Add SAMHSA Hotline Highlight** (AC: #5)
  - [ ] Import `Phone` icon from lucide-react
  - [ ] Check if `repairData.repairSuggestion` includes '1-800-662-4357'
  - [ ] Conditionally render prominent call button/link
  - [ ] Use `tel:1-800-662-4357` protocol for click-to-call
  - [ ] Style with purple theme (matches support widget)
  - [ ] Test on mobile (ensure click-to-call works)

- [ ] **Task 4: Update Component Tests** (AC: #7)
  - [ ] Update tests to mock longer AI responses
  - [ ] Test loading state renders spinner + message
  - [ ] Test scrollable container with long text
  - [ ] Test SAMHSA highlight conditional rendering
  - [ ] Test fallback response displays correctly
  - [ ] Ensure all 10 existing tests still pass

- [ ] **Task 5: Manual UX Testing** (AC: #6)
  - [ ] Test with real Gemini API (if available)
  - [ ] Test with mocked fallback response
  - [ ] Verify no error toast shows when fallback used
  - [ ] Test mobile responsiveness
  - [ ] Test accessibility (keyboard navigation, screen readers)

### Testing Strategy

**Component Test Updates** (`client/src/components/repair/__tests__/RepairFlow.test.tsx`):

1. **Renders Enhanced Loading State**
   - Given: RepairFlow mounted, user selects trigger
   - When: API call is pending
   - Then: Spinner with Loader2 icon is visible
   - And: "Finding the right support for you..." text is displayed
   - And: "This may take a moment" secondary text is displayed

2. **Displays Scrollable AI Response**
   - Given: API returns long AI response (300 words)
   - When: Response is rendered
   - Then: Suggestion container has scrollable styles
   - And: Full text is visible (not truncated)
   - And: Container has max-height and overflow-y-auto

3. **Highlights SAMHSA Hotline**
   - Given: API response includes "1-800-662-4357"
   - When: Suggestion is displayed
   - Then: Prominent SAMHSA call button is visible
   - And: Button has tel: link for click-to-call
   - And: Phone icon is displayed

4. **Handles Response Without SAMHSA**
   - Given: API response doesn't include hotline (edge case)
   - When: Suggestion is displayed
   - Then: Text displays normally
   - And: SAMHSA highlight is NOT rendered (conditional)

5. **Displays Fallback Response Seamlessly**
   - Given: Backend returns fallback response (AI failed)
   - When: Response is displayed
   - Then: User sees compassionate fallback text
   - And: No error toast is shown (seamless experience)
   - And: SAMHSA highlight shows (fallback includes hotline)

**Mock Data for Tests**:

```typescript
const mockAIResponse = {
  sessionId: "test-session-id",
  message: "Slips happen. What matters is what you do next.",
  repairSuggestion: "This craving is real, but it will pass. Right now, try the HALT technique: Are you Hungry, Angry, Lonely, or Tired? Address the root cause. Remember, cravings peak and fade in waves—delay for 15 minutes. If you need support right now, call SAMHSA National Helpline: 1-800-662-4357 (24/7, free, confidential)."
};

const mockFallbackResponse = {
  sessionId: "test-session-id",
  message: "Slips happen. What matters is what you do next.",
  repairSuggestion: "You're going through a difficult moment, and that takes courage to acknowledge. Right now, please reach out for support: Call SAMHSA National Helpline at 1-800-662-4357 (24/7, free, confidential) or text HOME to 741741 for Crisis Text Line. You don't have to face this alone."
};
```

**Acceptance Criteria → Test Coverage Mapping**:
- AC#1 (Loading state displayed): Test #1
- AC#2 (Compassionate loading message): Test #1
- AC#3 (AI response displays): Test #2
- AC#4 (UI adapts to length): Test #2
- AC#5 (SAMHSA highlighted): Test #3
- AC#6 (Fallback seamless): Test #5
- AC#7 (Existing tests pass): Full test suite run
- AC#8 (Loading skeleton/spinner): Test #1

### Dev Notes

**Context from Story 4.1A (Backend)**:
- API now returns AI-generated suggestions (150-300 words)
- Response includes SAMHSA National Helpline reference
- Fallback response returned if AI fails (transparent to frontend)
- API call time: 2-5 seconds (vs. <100ms before)

**Context from Story 4.1 (Current Frontend)**:
- `RepairFlow` component uses TanStack Query for API integration
- Current loading state: Simple "Loading..." text
- Current suggestion display: Single paragraph, no scrolling
- 10 component tests passing (all user interactions covered)

**Key Frontend Changes**:

1. **Loading State**: Spinner + compassionate message (2-5 seconds visible)
2. **Scrollable Container**: Handles longer AI responses (up to 300 words)
3. **SAMHSA Highlight**: Prominent call button if hotline detected in response
4. **No Error Handling Changes**: Backend handles fallback transparently

**UI Component Patterns** (from shadcn/ui):
- Using existing `Card`, `CardHeader`, `CardContent`, `Button` components
- Adding `Loader2` icon for spinner animation
- Adding `Phone` icon for SAMHSA call button
- Maintaining purple theme for support elements (matches `SupportWidget`)

**Accessibility Considerations**:
- Spinner has `aria-label="Loading repair suggestion"`
- SAMHSA link has `aria-label="Call SAMHSA National Helpline"`
- Scrollable container has `tabIndex={0}` for keyboard navigation
- Loading message uses `aria-live="polite"` for screen readers

**Mobile Considerations**:
- Modal remains full-screen on mobile (existing behavior)
- Scrollable container works with touch gestures
- `tel:` link enables click-to-call on mobile devices
- Font sizes remain readable on small screens

**Performance Considerations**:
- No performance impact (rendering AI text same as hardcoded text)
- Scrollable container handles up to 500 words without lag
- Conditional rendering of SAMHSA highlight is negligible cost

**Files to Modify**:
- `client/src/components/repair/RepairFlow.tsx` - Main component updates

**Files to Update**:
- `client/src/components/repair/__tests__/RepairFlow.test.tsx` - Test updates

**No New Files Required** - All changes within existing component

### Testing

**Test File Location**:
- Component tests: `client/src/components/repair/__tests__/RepairFlow.test.tsx`

**Testing Framework**:
- React Testing Library + Vitest (consistent with existing tests)
- Mock fetch responses for API calls
- Test user interactions (click, scroll, loading states)

**Test Coverage Requirements**:
- All new UI elements must have tests (loading spinner, SAMHSA highlight)
- All existing 10 component tests must continue to pass
- Test with both AI response and fallback response mocks
- Test mobile responsiveness (viewport testing)

**Running Tests**:
```bash
# Run repair flow component tests
npm test -- client/src/components/repair/__tests__/RepairFlow.test.tsx

# Run all repair flow tests (backend + frontend)
npm test -- repair

# Run full test suite
npm test
```

**Manual Testing Checklist**:
- [ ] Loading state shows for 2-5 seconds during real API call
- [ ] AI response displays with scrollable container
- [ ] SAMHSA hotline is prominently highlighted
- [ ] Click-to-call works on mobile (tel: link)
- [ ] Fallback response looks identical to AI response
- [ ] No error toast when fallback is used
- [ ] Modal is responsive on mobile/tablet/desktop
- [ ] Keyboard navigation works (Tab, Enter, Escape)
- [ ] Screen reader announces loading and SAMHSA link

---

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-14 | 1.0 | Initial story creation: AI-Powered Repair Suggestions (Frontend). Companion story to 4.1A (Backend). Enhances loading state, adds scrollable container for longer AI responses, highlights SAMHSA hotline with click-to-call. Ensures seamless UX whether AI succeeds or fallback is used. Story ready for implementation after 4.1A is complete. | Bob (Scrum Master) |
