# Story 4.3: Implement App Navigation & Hamburger Menu

### Status
Ready for Development

### Story
As a user in recovery using the Reentry Buddy PWA, I want consistent navigation on all pages so that I feel oriented, in control, and can easily access support and settings regardless of where I am in the app.

### Context
**Parent Story:** Story 4.2 (Improve Repair Flow Accessibility)  
**UX Review:** `docs/ux-reviews/4.2-support-widget-review-request.md`  
**Issue:** DailyRitual page lacks navigation, creating a "trapped" feeling especially critical in PWA mode where browser controls are hidden. This also blocks the deferred requirement from Story 4.2 to add "Need Support" menu item.

### Acceptance Criteria
1. **Persistent Header** on all authenticated pages (especially DailyRitual)
2. **Responsive Navigation Menu** component created:
   - Hamburger menu on mobile/tablet (â‰¤768px)
   - Horizontal navigation on desktop (>768px)
3. **"Need Support"** menu item present (completes Story 4.2 deferred requirement)
4. **Menu Structure:**
   - Daily Ritual (navigation link)
   - Divider
   - Need Support (opens RepairFlow)
   - Divider
   - Settings (placeholder for future)
   - Logout
5. **PWA-Friendly:**
   - Works without browser chrome
   - Mobile navigation feels native
   - Keyboard accessible (Tab, Enter, Escape)
6. **Visual Consistency:**
   - Uses existing Header component styling
   - Matches design system colors/spacing
   - Smooth animations for menu open/close

### Dependencies
- **REQUIRES**: Story 4.2 (Support Widget) completed
- **BLOCKS**: Future stories requiring navigation (Settings, Profile, Journal)
- Existing `Header.tsx` component
- Existing `RepairFlow` component
- shadcn/ui `Sheet` component for mobile menu

### Technical Context

**Existing Components to Modify:**
- `client/src/components/Header.tsx` - Add hamburger menu toggle & responsive nav
- `client/src/pages/DailyRitual.tsx` - Add Header component
- `client/src/App.tsx` - Consider layout wrapper for consistent header

**New Components to Create:**
- `client/src/components/navigation/NavigationMenu.tsx` - Mobile drawer menu
- `client/src/components/navigation/UserMenu.tsx` - Desktop dropdown menu
- `client/src/components/layout/AppLayout.tsx` - Wrapper for authenticated pages (optional but recommended)

**Design System:**
- Uses shadcn/ui Sheet (mobile menu)
- Uses shadcn/ui DropdownMenu (desktop user menu)
- Heart icon for "Need Support" (consistent with branding)
- Purple accent for support items

---

## Design Specifications

### Mobile Navigation (â‰¤768px)

**Header:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜°  ðŸ’™ Reentry Buddy        [Avatar] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Hamburger Menu (Sheet):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ’™ Reentry Buddy            â”‚
â”‚                              â”‚
â”‚  Welcome, user@email.com     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ  Daily Ritual             â”‚  â† Active page indicator
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ’™ Need Support             â”‚  â† Opens RepairFlow modal
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš™ï¸  Settings                â”‚  â† Placeholder (future)
â”‚  ðŸšª Logout                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Desktop Navigation (>768px)

**Header:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ’™ Reentry Buddy    Daily Ritual    [User Menu â–¼] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Menu (Dropdown):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user@email.com          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ’™ Need Support         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš™ï¸  Settings            â”‚
â”‚ ðŸšª Logout               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Tasks

### Task 1: Create NavigationMenu Component (Mobile)
**Estimated Effort:** 45 minutes

**File:** `client/src/components/navigation/NavigationMenu.tsx`

```tsx
import { useState } from "react";
import { Link, useLocation } from "react-router-dom";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { Menu, Home, Heart, Settings, LogOut } from "lucide-react";
import { useAuth } from "@/hooks/useAuth";

interface NavigationMenuProps {
  onOpenRepair: () => void;
}

export function NavigationMenu({ onOpenRepair }: NavigationMenuProps) {
  const [open, setOpen] = useState(false);
  const { user, logout, isLoggingOut } = useAuth();
  const location = useLocation();

  const handleNavigate = () => {
    setOpen(false);
  };

  const handleSupport = () => {
    setOpen(false);
    onOpenRepair();
  };

  const handleLogout = async () => {
    setOpen(false);
    await logout();
  };

  return (
    <Sheet open={open} onOpenChange={setOpen}>
      <SheetTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="md:hidden"
          aria-label="Open navigation menu"
        >
          <Menu className="h-6 w-6" />
        </Button>
      </SheetTrigger>
      <SheetContent side="left" className="w-72">
        <SheetHeader>
          <SheetTitle className="flex items-center gap-2">
            <Heart className="h-5 w-5 text-primary" />
            Reentry Buddy
          </SheetTitle>
          {user && (
            <p className="text-sm text-muted-foreground text-left">
              {user.email}
            </p>
          )}
        </SheetHeader>

        <nav className="mt-6 space-y-1">
          <Link
            to="/daily-ritual"
            onClick={handleNavigate}
            className={`flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent ${
              location.pathname === "/daily-ritual"
                ? "bg-accent text-accent-foreground"
                : ""
            }`}
          >
            <Home className="h-5 w-5" />
            <span>Daily Ritual</span>
          </Link>

          <Separator className="my-4" />

          <button
            onClick={handleSupport}
            className="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-purple-50 text-purple-700 w-full text-left"
          >
            <Heart className="h-5 w-5" />
            <span>Need Support</span>
          </button>

          <Separator className="my-4" />

          <button
            disabled
            className="flex items-center gap-3 px-3 py-2 rounded-md opacity-50 cursor-not-allowed w-full text-left"
            title="Coming soon"
          >
            <Settings className="h-5 w-5" />
            <span>Settings</span>
          </button>

          <button
            onClick={handleLogout}
            disabled={isLoggingOut}
            className="flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent text-destructive w-full text-left"
          >
            <LogOut className="h-5 w-5" />
            <span>{isLoggingOut ? "Logging out..." : "Logout"}</span>
          </button>
        </nav>
      </SheetContent>
    </Sheet>
  );
}
```

---

### Task 2: Create UserMenu Component (Desktop)
**Estimated Effort:** 30 minutes

**File:** `client/src/components/navigation/UserMenu.tsx`

```tsx
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Heart, Settings, LogOut, ChevronDown } from "lucide-react";
import { useAuth } from "@/hooks/useAuth";

interface UserMenuProps {
  onOpenRepair: () => void;
}

export function UserMenu({ onOpenRepair }: UserMenuProps) {
  const { user, logout, isLoggingOut } = useAuth();

  if (!user) return null;

  const initials = user.email
    ?.split("@")[0]
    .substring(0, 2)
    .toUpperCase() || "U";

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="flex items-center gap-2">
          <Avatar className="h-8 w-8">
            <AvatarFallback>{initials}</AvatarFallback>
          </Avatar>
          <span className="hidden lg:inline text-sm">{user.email}</span>
          <ChevronDown className="h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuLabel>{user.email}</DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem
          onClick={onOpenRepair}
          className="text-purple-700 cursor-pointer"
        >
          <Heart className="mr-2 h-4 w-4" />
          <span>Need Support</span>
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem disabled className="opacity-50">
          <Settings className="mr-2 h-4 w-4" />
          <span>Settings</span>
        </DropdownMenuItem>
        <DropdownMenuItem
          onClick={logout}
          disabled={isLoggingOut}
          className="text-destructive cursor-pointer"
        >
          <LogOut className="mr-2 h-4 w-4" />
          <span>{isLoggingOut ? "Logging out..." : "Logout"}</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

---

### Task 3: Update Header Component
**Estimated Effort:** 30 minutes

**File:** `client/src/components/Header.tsx`

```tsx
import { Link } from "react-router-dom";
import { Heart } from "lucide-react";
import { useAuth } from "@/hooks/useAuth";
import { NavigationMenu } from "@/components/navigation/NavigationMenu";
import { UserMenu } from "@/components/navigation/UserMenu";

interface HeaderProps {
  onOpenRepair?: () => void;
}

export default function Header({ onOpenRepair }: HeaderProps) {
  const { isAuthenticated } = useAuth();

  return (
    <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container flex h-16 items-center justify-between px-4 md:px-6">
        <div className="flex items-center gap-4">
          {isAuthenticated && onOpenRepair && (
            <NavigationMenu onOpenRepair={onOpenRepair} />
          )}
          
          <Link to="/" className="flex items-center gap-2" data-testid="link-home">
            <Heart className="h-6 w-6 text-primary" />
            <span className="text-xl font-bold">Reentry Buddy</span>
          </Link>

          {isAuthenticated && (
            <nav className="hidden md:flex items-center gap-6 ml-6">
              <Link
                to="/daily-ritual"
                className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
              >
                Daily Ritual
              </Link>
            </nav>
          )}
        </div>
        
        {isAuthenticated && onOpenRepair && (
          <div className="hidden md:block">
            <UserMenu onOpenRepair={onOpenRepair} />
          </div>
        )}
      </div>
    </header>
  );
}
```

---

### Task 4: Create AppLayout Wrapper (Optional but Recommended)
**Estimated Effort:** 20 minutes

**File:** `client/src/components/layout/AppLayout.tsx`

```tsx
import { useState } from "react";
import { Outlet } from "react-router-dom";
import Header from "@/components/Header";
import { RepairFlow } from "@/components/repair/RepairFlow";

export function AppLayout() {
  const [showRepairFlow, setShowRepairFlow] = useState(false);

  return (
    <div className="min-h-screen flex flex-col">
      <Header onOpenRepair={() => setShowRepairFlow(true)} />
      <main className="flex-1">
        <Outlet />
      </main>
      {showRepairFlow && (
        <RepairFlow onClose={() => setShowRepairFlow(false)} />
      )}
    </div>
  );
}
```

---

### Task 5: Update DailyRitual Page
**Estimated Effort:** 15 minutes

**Option A: Direct Header Import (Quick)**
```tsx
// Add to top of DailyRitual.tsx
import Header from "@/components/Header";

// Update return statement
return (
  <>
    <Header onOpenRepair={() => setShowRepairFlow(true)} />
    <div className="container mx-auto p-4 max-w-md">
      {/* existing content */}
    </div>
  </>
);
```

**Option B: Use AppLayout (Better for scaling)**
```tsx
// Update App.tsx routes
<Route 
  path="/daily-ritual" 
  element={
    <ProtectedRoute>
      <AppLayout />
    </ProtectedRoute>
  }
>
  <Route index element={<DailyRitual />} />
</Route>
```

---

### Task 6: Add Missing shadcn/ui Components
**Estimated Effort:** 10 minutes

```bash
# Add Sheet component (for mobile menu)
npx shadcn-ui@latest add sheet

# Add DropdownMenu component (for desktop user menu)
npx shadcn-ui@latest add dropdown-menu

# Add Avatar component (for user menu)
npx shadcn-ui@latest add avatar

# Add Separator component (for menu dividers)
npx shadcn-ui@latest add separator
```

---

### Task 7: Update Tests
**Estimated Effort:** 45 minutes

**Files to Create/Update:**
- `client/src/components/navigation/__tests__/NavigationMenu.test.tsx`
- `client/src/components/navigation/__tests__/UserMenu.test.tsx`
- Update `client/src/components/__tests__/Header.test.tsx`

**Test Scenarios:**
1. Mobile menu opens/closes correctly
2. "Need Support" triggers RepairFlow modal
3. Navigation links work correctly
4. Logout button calls logout function
5. Active page indicator shows correctly
6. Desktop menu renders on larger screens
7. Keyboard navigation works (Tab, Enter, Escape)

---

## Edge Cases & Considerations

### Responsive Breakpoints
- Mobile: 0-768px (hamburger menu)
- Desktop: >768px (horizontal nav + user menu)
- Use Tailwind's `md:` prefix consistently

### Accessibility
- Hamburger button has `aria-label="Open navigation menu"`
- Sheet closes on Escape key (built into shadcn Sheet)
- All interactive elements keyboard accessible
- Active page visually indicated for screen readers

### PWA Considerations
- Navigation works without browser chrome
- Menu feels native on mobile
- No reliance on browser back button
- Offline state handled gracefully (future enhancement)

### State Management
- RepairFlow modal state can be at layout level OR page level
- If using AppLayout, manage modal state there (centralized)
- If not using AppLayout, pass `onOpenRepair` to Header from each page

---

## Testing Checklist

**Manual Testing:**
- [ ] Header appears on all authenticated pages
- [ ] Hamburger menu opens/closes on mobile
- [ ] "Need Support" menu item opens RepairFlow modal
- [ ] Logout button works from both mobile and desktop menus
- [ ] Desktop user menu dropdown works
- [ ] Navigation links navigate correctly
- [ ] Active page indicator shows current page
- [ ] Responsive design works at breakpoints (375px, 768px, 1024px, 1440px)
- [ ] Keyboard navigation: Tab to hamburger, Enter to open, Tab through items, Escape to close
- [ ] Works in PWA mode (install app and test)

**Automated Testing:**
- [ ] All existing tests still pass
- [ ] New NavigationMenu tests pass
- [ ] New UserMenu tests pass
- [ ] Header tests updated and passing

---

## Acceptance Testing

**Scenario 1: Mobile User Opens Menu**
1. User views DailyRitual page on mobile (375px width)
2. User sees hamburger icon in top-left of header
3. User taps hamburger icon
4. Drawer slides in from left with navigation options
5. User sees "Need Support" with purple styling
6. User taps "Need Support"
7. RepairFlow modal opens
8. Drawer closes automatically

**Scenario 2: Desktop User Accesses Support**
1. User views DailyRitual page on desktop (1440px width)
2. User sees horizontal navigation in header
3. User sees avatar/email in top-right
4. User clicks user menu dropdown
5. Dropdown opens with "Need Support" option
6. User clicks "Need Support"
7. RepairFlow modal opens
8. Dropdown closes automatically

**Scenario 3: PWA Mode Navigation**
1. User installs app as PWA (no browser chrome)
2. User opens installed app
3. User sees full navigation in header
4. User can navigate to all pages without browser back button
5. User feels oriented and in control

---

## Success Metrics

**User Experience:**
- Reduced bounce rate from DailyRitual page
- Increased engagement with "Need Support" feature
- Positive user feedback on navigation clarity
- No complaints about feeling "trapped" in the app

**Technical:**
- Lighthouse accessibility score maintained (95+)
- No navigation-related bugs reported
- All tests passing
- PWA navigation works seamlessly

---

## Future Enhancements (Out of Scope)

These are noted for future stories but NOT required for Story 4.3:

- **Story 4.4:** Settings page implementation
- **Story 4.5:** Profile page implementation
- **Story 4.6:** Breadcrumb navigation for nested pages
- **Story 4.7:** Navigation analytics tracking
- **Story 4.8:** Offline navigation handling

---

## Dev Notes

**Design Rationale:**
- Hamburger menu on mobile saves precious vertical space
- Purple accent for "Need Support" maintains emotional safety color scheme
- Persistent header provides consistent orientation across all pages
- Desktop user menu groups account-related actions logically

**Trade-offs:**
- AppLayout wrapper adds abstraction but improves scalability
- Managing RepairFlow modal state at layout level vs. page level
- Decision: Recommend AppLayout for future scalability

**Open Questions:**
- Should Settings be a placeholder or hidden until implemented? (Decision: Show as disabled placeholder)
- Should we add breadcrumbs for nested pages? (Decision: No, out of scope)

---

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-12 | 1.0 | Initial story created based on UX review findings. Implements essential navigation for PWA usage and completes deferred Story 4.2 requirement for "Need Support" menu item. | Sally (UX Expert) |
