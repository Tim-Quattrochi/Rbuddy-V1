# Story 5.2: View Journal History

### Status
Approved

### Story
As an authenticated user, I want to view my previous journal entries in chronological order, so that I can reflect on my recovery journey over time and track my emotional progress.

### Acceptance Criteria
1. A "View Journal" navigation link or button is accessible from the main navigation or daily ritual page.
2. Clicking the link navigates to a dedicated `/journal` page that displays the user's journal entries.
3. Journal entries are displayed in reverse chronological order (most recent first).
4. Each entry displays: the date/time it was created and the full journal text.
5. A new backend endpoint `GET /api/journal/history` returns the authenticated user's journal entries with pagination support (limit: 20 entries per page).
6. The UI displays an empty state message (e.g., "No journal entries yet. Start writing to track your journey!") when the user has no journal entries.
7. The journal history page is mobile-responsive and follows the app's design system.
8. Users can scroll or paginate through older entries (implement infinite scroll or pagination).

### Tasks / Subtasks
- [x] **Task 1: Backend - Create Journal History API** (AC: #5)
  - [x] Create new API endpoint `GET /api/journal/history` with authentication middleware.
  - [x] Query the `interactions` table filtering by `userId` and `contentType = 'journal_entry'`.
  - [x] Implement pagination (query params: `limit` (default 20), `offset`).
  - [x] Return entries sorted by `createdAt DESC` with fields: `id`, `body`, `createdAt`.
  - [x] Add error handling for database queries and authentication failures.
- [x] **Task 2: Frontend - Create Journal History Page** (AC: #2, #3, #4, #6, #7)
  - [x] Create new page component `client/src/pages/Journal.tsx`.
  - [x] Use shadcn/ui components (Card, ScrollArea) for journal entry display.
  - [x] Implement date formatting utility for readable timestamps.
  - [x] Add empty state UI with encouraging message and icon.
  - [x] Ensure mobile-responsive layout with proper spacing and typography.
- [x] **Task 3: Frontend - Add Navigation** (AC: #1)
  - [x] Add "Journal" link to the main navigation (Header or sidebar).
  - [x] Update React Router in `App.tsx` to include `/journal` route.
  - [x] Wrap the journal route with authentication protection.
- [x] **Task 4: Frontend - Implement Data Fetching** (AC: #8)
  - [x] Create a `useQuery` hook to fetch journal entries from `/api/journal/history`.
  - [x] Implement infinite scroll using Intersection Observer or pagination controls.
  - [x] Add loading states and error handling UI.
  - [x] Handle empty response gracefully.
- [x] **Task 5: Write Tests**
  - [x] Write API integration tests for `GET /api/journal/history` endpoint.
  - [x] Test authentication requirement, pagination, and data filtering.
  - [x] Write component tests for `Journal.tsx` page.
  - [x] Test empty state, loading state, and successful data display.
  - [x] Test responsive layout and accessibility.

### Dev Notes
* This story depends on Story 5.1 (journal entry creation functionality must exist).
* The `interactions` table already stores journal entries with `contentType = 'journal_entry'`.
* Consider adding a search/filter feature in a future story (date range, keyword search).
* Future enhancements could include entry editing, deletion, or exporting.

#### Testing
- **Test file locations:**
  - API integration tests: `api/journal/history.test.ts` (new)
  - Component tests: `client/src/pages/__tests__/Journal.test.tsx` (new)
- **Testing frameworks:**
  - Frontend: Vitest + React Testing Library
  - Backend: Vitest with supertest for API testing
- **Testing standards:**
  - Follow existing patterns from `DailyRitual.test.tsx` and other page tests
  - Test authentication flow (redirect if not logged in)
  - Mock API calls using `vi.mock` for fetch requests
  - Test pagination/infinite scroll behavior
  - Ensure accessibility testing (ARIA labels, semantic HTML, keyboard navigation)
- **Coverage requirements:**
  - API tests: Authentication, pagination, filtering by contentType, proper sorting
  - Unit tests: Component rendering, empty state, loading state, error state
  - Integration tests: Full flow from page load to data display
  - Edge cases: No entries, single entry, many entries (pagination)

### Design Considerations
* Use calming colors and spacing consistent with the wellness theme.
* Journal entries should be easy to read with appropriate line height and font size.
* Consider adding subtle visual separators between entries.
* Date formatting should be user-friendly (e.g., "Today", "Yesterday", "Oct 12, 2025").

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-12 | 1.0 | Initial story creation for viewing journal history. | John (PM) |

### Dev Agent Record

#### File List
**API:**
- `api/journal/history.ts` (NEW) – Provides authenticated journal history endpoint with limit/offset pagination and safe error responses.
- `api/journal/history.test.ts` (NEW) – Covers successful pagination, auth guard, and error handling.

**Frontend:**
- `client/src/pages/Journal.tsx` (NEW) – Renders journal history layout, empty state, and paginated loader using shadcn components.
- `client/src/hooks/useJournalHistory.ts` (NEW) – Exposes infinite-query helper around `/api/journal/history`.
- `client/src/lib/datetime.ts` (NEW) – Formats timestamps for journal entry headers.
- `client/src/App.tsx` (UPDATED) – Registers protected `/journal` route under shared layout shell.
- `client/src/components/Header.tsx` (UPDATED) – Adds desktop navigation link for Journal.
- `client/src/components/navigation/NavigationMenu.tsx` (UPDATED) – Adds mobile Journal entry and preserves existing flows.

**Tests:**
- `client/src/pages/__tests__/Journal.test.tsx` (NEW) – Validates happy path, empty state, retry, and load-more interactions.

#### Completion Notes
- AC #1 satisfied with new "Journal" links in both header navigation and mobile sheet.
- AC #2–#4 delivered through `JournalPage` rendering paginated cards with formatted timestamps.
- AC #5 implemented via `/api/journal/history` endpoint querying `interactions` filtered on `journal_entry` with pagination metadata.
- AC #6 shows encouraging empty-state card with Notebook icon and guidance copy.
- AC #7 leverages responsive container spacing plus shadcn `ScrollArea` for mobile and desktop parity.
- AC #8 enables pagination through React Query infinite loader and "Load more entries" control.
- Added Vitest suites for backend handler and Journal page states; ran targeted tests plus full `npm run check` and `npm run build`.

#### Debug Log References
- `npm run test -- --run api/journal/history.test.ts client/src/pages/__tests__/Journal.test.tsx`
- `npm run check`
- `npm run build`

#### Story DoD Checklist
- [x] All functional requirements implemented; acceptance criteria satisfied.
- [x] Code adheres to project standards, structure, and data model expectations.
- [x] New/updated code covered by required unit and integration tests; all tests pass.
- [ ] Functionality manually exercised in UI (not executed in this environment; recommend QA smoke check).
- [x] Edge cases handled (empty state, pagination, auth failures).
- [x] Story tasks updated and documented in this record.
- [x] Project build and type check executed successfully (`npm run build`, `npm run check`).
- [x] Inline documentation added where necessary.
- [x] Dev agent confirms applicable DoD items are addressed.

## QA Results
(To be filled by QA team)
