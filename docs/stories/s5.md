### **Story 5: Database Logging**

**User Story:**
As a developer, I need to persist completed session data and all related SMS messages to the database, so that we have a durable record of interactions and can enable features like streak tracking.

**Story Context:**
*   **Existing System Integration:** This story connects the `ConversationEngine` to the database schema created in Story 1. It will use the Drizzle client from `server/storage.ts`.
*   **Technology:** TypeScript, Drizzle ORM, Neon PostgreSQL.
*   **Follows pattern:** Implements the `saveSession` method as described in the `ConversationEngine` interface in `docs/architecture/component-architecture.md`.
*   **Touch points:**
    *   `server/services/conversationEngine.ts` will be updated to handle database writes.
    *   `server/storage.ts` will be imported and used by the `ConversationEngine`.

**Acceptance Criteria:**
1.  The `ConversationEngine` is updated to accept and use the Drizzle client from `server/storage.ts`.
2.  Upon successful completion of a daily ritual flow, a new record is created in the `sessions` table.
3.  The new `sessions` record correctly stores the `userId`, `flowType` ('daily'), `channel` ('sms'), `mood`, and `intention` from the `ConversationState`.
4.  Every inbound SMS message from the user is saved as a new record in the `messages` table.
5.  Every outbound SMS message sent by the system is saved as a new record in the `messages` table.
6.  Each record in the `messages` table is correctly associated with its corresponding session via the `sessionId`.
7.  The `direction`, `fromNumber`, `toNumber`, `body`, and `twilioSid` are all correctly stored for each message.

**Technical Notes:**
*   **Integration Approach:** The Drizzle client should be passed to the `ConversationEngine`'s constructor or relevant methods to facilitate database access and enable easier testing.
*   **Existing Pattern Reference:** The database interaction should use the Drizzle schema and client as already established in the project.
*   **Key Constraints:** Ensure that database operations are performed asynchronously and do not block the response to Twilio. Errors in database logging should be handled gracefully and logged for debugging.

**Definition of Done:**
*   [ ] A completed daily ritual flow results in one new `sessions` record and multiple new `messages` records.
*   [ ] All data is stored accurately and relationships between tables are correctly established.
*   [ ] Unit tests for the database logging logic (using a mock DB client) pass.
*   [ ] Code has been reviewed and approved by the Architect.
