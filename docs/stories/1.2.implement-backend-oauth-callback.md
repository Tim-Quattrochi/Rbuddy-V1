# Story 1.2: Implement Backend Google OAuth Callback

### Status
Draft

### Story
As a developer, I need to implement the backend Google OAuth callback endpoint, so that the application can securely handle authentication responses from Google and issue session tokens.

### Acceptance Criteria
1.  An API endpoint at `GET /api/auth/google` successfully initiates the Google OAuth flow by redirecting the user.
2.  An API endpoint at `GET /api/auth/google/callback` is created to handle the callback from Google.
3.  The callback endpoint uses the `passport-google-oauth20` strategy to process the response.
4.  Upon receiving a valid profile from Google, the system correctly finds an existing user by their `googleId` OR creates a new user in the database.
5.  A new application-specific JWT is generated for the authenticated user.
6.  The JWT is set as a secure, `HttpOnly` cookie in the browser.
7.  After the cookie is set, the user is redirected to the `/daily-ritual` page on the frontend.
8.  All necessary credentials (e.g., `GOOGLE_CLIENT_ID`) are loaded securely from environment variables.

### Tasks / Subtasks
- [ ] **Task 1: Configure Passport.js Google Strategy** (AC: #3, #8)
    - [ ] Install `passport-google-oauth20` and its corresponding `@types`.
    - [ ] Create a new `server/services/AuthService.ts` file to encapsulate all Passport.js configuration.
    - [ ] Configure the `GoogleStrategy` with the Client ID, Client Secret, and callback URL from environment variables.
- [ ] **Task 2: Implement User Find/Create Logic** (AC: #4)
    - [ ] Within the Passport strategy's `verify` callback function, use Drizzle to query the `users` table for a user with the matching Google profile ID.
    - [ ] If a user exists, return the user object.
    - [ ] If no user exists, create a new record in the `users` table using the email, Google ID, and avatar URL from the Google profile. Return the newly created user object.
- [ ] **Task 3: Create API Routes** (AC: #1, #2, #5, #6, #7)
    - [ ] Create the `api/auth/google/index.ts` route file to handle the initial redirect, calling `passport.authenticate('google', { scope: ['profile', 'email'] })`.
    - [ ] Create the `api/auth/google.callback.ts` route file.
    - [ ] In the callback route, use `passport.authenticate` and, upon success, sign a new application JWT containing the user's ID.
    - [ ] Set the signed JWT in an `HttpOnly` cookie and redirect the user to `/daily-ritual`.
- [ ] **Task 4: Write Tests**
    - [ ] Write integration tests for the new API endpoints, mocking the calls to Google's servers.
    - [ ] Write unit tests for the find-or-create user logic in `AuthService.ts`.

### Dev Notes
* This story is dependent on **Story 1.1 (Database Schema Update)** being complete.
* The core Passport.js logic should be encapsulated in `AuthService.ts` as defined in the architecture document.
* The API routes themselves should be lean. Ensure the `state` parameter is used by Passport to prevent CSRF attacks.
* Refer to the `Security Integration` section of the architecture document for cookie flag requirements (`HttpOnly`, `Secure`, `SameSite`).

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial story creation. | Scrum Master |