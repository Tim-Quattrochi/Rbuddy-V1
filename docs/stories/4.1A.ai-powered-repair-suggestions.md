# Story 4.1A: AI-Powered Repair Suggestions (Backend)

### Status
Draft

### Story
**As a** user experiencing a trigger,  
**I want** personalized, context-aware repair suggestions generated by AI,  
**so that** I receive appropriate support that understands my unique situation and recovery journey.

### Acceptance Criteria
1. When a user selects a trigger in the repair flow, the backend calls an AI service instead of returning hardcoded suggestions
2. The AI service receives context including: trigger type, user's recent mood, recent intentions, and streak count
3. The AI response is compassionate, evidence-based, and recovery-focused
4. The AI always includes connection to SAMHSA National Helpline (1-800-662-4357) in the response
5. If AI call fails, the system falls back to a safe default response connecting the user to human resources
6. The AI-generated suggestion is logged to the interactions table (same as current implementation)
7. All existing repair flow tests continue to pass with updated AI integration
8. The system uses rate limiting to prevent abuse (integrated with existing chat rate limits)

### Dependencies
- **REQUIRES**: Story 4.1 (Implement PWA Rupture & Repair Flow) must be completed
- **REQUIRES**: AI Chat infrastructure must be available (`api/_lib/services/aiChatService.ts`)
- **REQUIRES**: Environment variables for AI provider (OPENAI_API_KEY, GEMINI_API_KEY, or ANTHROPIC_API_KEY)
- Existing `ConversationEngine` service at `server/services/conversationEngine.ts`
- Existing `RepairFlow` component at `client/src/components/repair/RepairFlow.tsx`

### Technical Context

**Existing AI Chat Infrastructure** (from ad-hoc AI Chat feature):
- **Service Location**: `api/_lib/services/aiChatService.ts`
- **Multi-Provider Support**: OpenAI, Google Gemini, Mistral, Perplexity (configured via `AI_PROVIDER` env var)
- **Context Awareness**: Already accesses user mood, intentions, and streak from sessions table
- **Rate Limiting**: Existing rate limiters at `api/_lib/middleware/rateLimiter.ts`
  - `chatSendLimiter`: 20 messages per hour per user
  - Applied to `/api/chat/send` endpoint

**Current Repair Flow Implementation** (from Story 4.1):
- **API Endpoint**: `POST /api/repair/start` at `api/repair/start.ts`
- **Hardcoded Suggestions**: Located in `server/services/conversationEngine.ts` as `REPAIR_SUGGESTIONS` map
- **Flow**: User selects trigger → API returns suggestion → RepairFlow displays it
- **Database Logging**: Suggestion logged to `interactions` table with `contentType: 'text'`

**Integration Pattern**:
- Similar to how `AIChatService` generates responses for general chat
- Create repair-specific system prompt with clinical guidelines
- Pass trigger context + user context (mood, intentions, streak)
- Validate AI response includes required safety elements (SAMHSA hotline)
- Fallback to safe default if AI unavailable or response invalid

### API Contract

**Endpoint:** `POST /api/repair/start` (existing, will be modified)

**Authentication:** Required (uses `requireAuth` middleware)

**Request Body:** (unchanged)
```json
{
  "trigger": "stress" | "people" | "craving"
}
```

**Success Response (200):** (structure unchanged)
```json
{
  "sessionId": "uuid-string",
  "message": "Slips happen. What matters is what you do next.",
  "repairSuggestion": "AI-generated contextual suggestion with SAMHSA hotline reference"
}
```

**Example AI-Generated Suggestions**:
```json
{
  "trigger": "craving",
  "repairSuggestion": "This craving is real, but it will pass. Right now, try the HALT technique: Are you Hungry, Angry, Lonely, or Tired? Address the root cause. Remember, cravings peak and fade in waves—delay for 15 minutes. If you need support right now, call SAMHSA National Helpline: 1-800-662-4357 (24/7, free, confidential)."
}
```

**Fallback Response** (if AI unavailable):
```json
{
  "repairSuggestion": "You're going through a difficult moment, and that takes courage to acknowledge. Right now, please reach out for support: Call SAMHSA National Helpline at 1-800-662-4357 (24/7, free, confidential) or text HOME to 741741 for Crisis Text Line. You don't have to face this alone."
}
```

**Error Responses:** (unchanged)
- `401 Unauthorized`: User not authenticated
- `400 Bad Request`: Invalid trigger value
- `500 Internal Server Error`: Database or server error (with fallback response)

### Data Model

**No Schema Changes Required**:
- Existing `sessions` table: Already stores `flowType: 'repair'`
- Existing `interactions` table: Already stores AI-generated text as `contentType: 'text'`
- Existing `chatMessages` table: Not used for repair flow (repair responses are ephemeral, not persistent chat)

**Rate Limiting Consideration**:
- Option A: Repair flow calls count toward existing 20 messages/hour chat limit
- Option B: Create separate rate limit for repair flow (e.g., 10 repair flows per day per user)
- **Recommendation**: Option B (separate limit) - repair flows are crisis moments and shouldn't be blocked by general chat usage

### System Prompt Design

**Repair Flow System Prompt** (to be created):
```typescript
// Location: api/_lib/services/aiChatService.ts or new file api/_lib/services/repairPrompts.ts

export function createRepairSystemPrompt(trigger: string, context: UserContext): string {
  return `You are a compassionate recovery support AI helping someone experiencing a trigger.

CRITICAL SAFETY RULES:
- ALWAYS validate their experience ("This is hard, and you're not alone")
- NEVER minimize cravings, stress, or triggers
- ALWAYS include SAMHSA National Helpline: 1-800-662-4357 as a resource
- If user expresses crisis/harm intent, IMMEDIATELY prioritize hotline
- Use evidence-based techniques: HALT, Urge Surfing, 5-4-3-2-1 Grounding
- Keep response concise (3-4 sentences, ~150 words max)

USER CONTEXT:
- Trigger: ${trigger}
- Recent mood: ${context.recentMood || 'unknown'}
- Recent intention: ${context.recentIntention || 'not set'}
- Streak: ${context.streakCount || 0} days

EVIDENCE-BASED TECHNIQUES TO REFERENCE:
- HALT: Check if Hungry, Angry, Lonely, or Tired
- Urge Surfing: Cravings peak and pass in waves, delay for 15 minutes
- 5-4-3-2-1 Grounding: Name 5 things you see, 4 you hear, 3 you touch, 2 you smell, 1 you taste
- Delay and Distract: Put distance between urge and action
- SMART Recovery: 4-Point Program (motivation, coping, relationships, lifestyle)

Provide 2-3 specific, actionable suggestions based on the trigger, then include SAMHSA hotline.`;
}
```

**Prompt Engineering Validation**:
- Response MUST include "SAMHSA" or "1-800-662-4357" (regex validation)
- Response length between 50-300 words (configurable)
- Response tone: compassionate, non-judgmental, evidence-based
- If validation fails, use fallback response

### Edge Cases to Handle

**AI Service Unavailable**:
- API key missing or invalid
- AI provider service down
- Network timeout
- **Solution**: Use safe fallback response connecting to SAMHSA hotline

**AI Response Invalid**:
- Response doesn't include SAMHSA hotline
- Response is too long (>500 words)
- Response contains inappropriate content
- **Solution**: Use fallback response, log error for review

**Rate Limit Exceeded**:
- User has exceeded repair flow limit (if implementing separate limit)
- **Solution**: Return fallback response with SAMHSA hotline (don't block crisis support)

**Context Data Missing**:
- User has no recent sessions (new user)
- Mood/intentions not set
- **Solution**: AI prompt handles missing context gracefully

**Multiple Providers**:
- Different AI providers may format responses differently
- **Solution**: Normalize responses after AI call (trim, validate, format)

**Cost Considerations**:
- AI API calls have usage costs
- **Solution**: Monitor usage, set reasonable rate limits, consider caching similar requests

### Tasks / Subtasks

- [ ] **Task 1: Create Repair-Specific AI Service** (AC: #1, #2, #3)
  - [ ] Create new file `api/_lib/services/repairAIService.ts` (or extend `aiChatService.ts`)
  - [ ] Implement `createRepairSystemPrompt(trigger, context)` function with evidence-based guidelines
  - [ ] Implement `generateRepairSuggestion(userId, trigger)` function that:
    - Fetches user context (mood, intentions, streak) from sessions table
    - Calls AI service with repair-specific system prompt
    - Validates response includes SAMHSA hotline reference
    - Returns validated suggestion or fallback
  - [ ] Add response validation logic (regex for SAMHSA, length check, content filtering)

- [ ] **Task 2: Integrate AI Service into ConversationEngine** (AC: #1, #6)
  - [ ] Modify `server/services/conversationEngine.ts` `handlePwaRepairFlow` method
  - [ ] Replace `REPAIR_SUGGESTIONS[trigger]` lookup with call to `RepairAIService.generateRepairSuggestion(userId, trigger)`
  - [ ] Keep `REPAIR_SUGGESTIONS` as fallback map (deprecate but preserve for safety)
  - [ ] Ensure AI-generated suggestion is logged to interactions table (existing behavior)

- [ ] **Task 3: Implement Rate Limiting Strategy** (AC: #8)
  - [ ] Decide on rate limiting approach (Option A: shared with chat, Option B: separate limit)
  - [ ] If Option B: Create `repairFlowLimiter` in `api/_lib/middleware/rateLimiter.ts`
  - [ ] Apply rate limiter to `POST /api/repair/start` endpoint
  - [ ] Document rate limit in API comments

- [ ] **Task 4: Add Fallback Safety Net** (AC: #4, #5)
  - [ ] Create `SAFE_FALLBACK_RESPONSE` constant with SAMHSA hotline connection
  - [ ] Implement try-catch around AI service call
  - [ ] On AI failure: log error, return fallback response, ensure session still created
  - [ ] Add monitoring/logging for AI failures (count failures for alerting)

- [ ] **Task 5: Write Tests** (AC: #7)
  - [ ] **Unit Tests - RepairAIService** (`api/_lib/services/__tests__/repairAIService.test.ts`):
    - Test prompt generation includes all required safety rules
    - Test response validation (SAMHSA hotline presence, length, content)
    - Test fallback logic when AI unavailable
    - Test context handling (with/without mood, intentions, streak)
  - [ ] **Integration Tests - Repair Flow with AI** (`api/repair/start.test.ts`):
    - Update existing tests to mock AI service responses
    - Test AI-generated suggestion is returned and logged
    - Test fallback response when AI fails
    - Test rate limiting (if implementing separate limit)
    - Ensure all existing AC from Story 4.1 still pass
  - [ ] **Prompt Engineering Tests**:
    - Test various trigger + context combinations
    - Validate AI responses meet clinical guidelines
    - Test edge cases (missing context, extreme inputs)

### Testing Strategy

**Test Scenarios for RepairAIService**:

1. **Generates Compassionate Response for Each Trigger**
   - Given: User selects "craving" trigger with context (mood: "struggling", streak: 5)
   - When: `generateRepairSuggestion(userId, "craving")` is called
   - Then: AI returns response including HALT technique, urge surfing, and SAMHSA hotline
   - And: Response is validated and passes all safety checks

2. **Includes SAMHSA Hotline in All Responses**
   - Given: Any trigger type ("stress", "people", "craving")
   - When: AI generates response
   - Then: Response contains "1-800-662-4357" or "SAMHSA National Helpline"
   - And: Validation passes

3. **Handles Missing User Context Gracefully**
   - Given: New user with no prior sessions
   - When: `generateRepairSuggestion(userId, "stress")` is called
   - Then: AI prompt handles missing mood/intentions
   - And: Response is still compassionate and includes hotline

4. **Falls Back When AI Service Unavailable**
   - Given: AI API key is invalid or service is down
   - When: `generateRepairSuggestion(userId, "craving")` is called
   - Then: Safe fallback response is returned
   - And: Fallback includes SAMHSA hotline and compassionate message
   - And: Error is logged for monitoring

5. **Validates Response Length and Content**
   - Given: AI returns very long response (>500 words)
   - When: Response validation runs
   - Then: Response is rejected, fallback is used
   - And: Error is logged

6. **Rejects Response Without Safety Resources**
   - Given: AI returns response without SAMHSA hotline reference
   - When: Response validation runs
   - Then: Response is rejected, fallback is used
   - And: Error is logged for prompt engineering review

**Integration Test Updates (api/repair/start.test.ts)**:

- Update mocks to simulate AI service responses
- Test that `POST /api/repair/start` calls AI service with correct context
- Verify AI response is returned in API response body
- Verify AI response is logged to interactions table
- Test fallback behavior when AI throws error
- Ensure all existing tests from Story 4.1 still pass (16 tests)

**Acceptance Criteria → Test Coverage Mapping**:
- AC#1 (AI called instead of hardcoded): Integration test #1
- AC#2 (Context passed to AI): Unit test #1, #3
- AC#3 (Compassionate, evidence-based): Unit test #1, #6
- AC#4 (Includes SAMHSA hotline): Unit test #2
- AC#5 (Fallback on failure): Unit test #4, Integration test fallback
- AC#6 (Logged to interactions): Integration test #2
- AC#7 (Existing tests pass): Full test suite run
- AC#8 (Rate limiting): Integration test rate limit (if separate limit)

### Dev Notes

**Context from Previous Story (4.1)**:
- Repair flow is fully functional with hardcoded suggestions
- `ConversationEngine.handlePwaRepairFlow` method creates session, logs interactions, returns suggestion
- `RepairFlow.tsx` component displays suggestions in modal UI
- 16 tests passing (6 API + 10 component tests)
- **BLOCKER IDENTIFIED**: Hardcoded suggestions lack therapeutic depth (see `docs/REPAIR_FLOW_CONTENT_BLOCKER.md`)

**AI Chat Infrastructure Available**:
- `AIChatService` class at `api/_lib/services/aiChatService.ts`
- Multi-provider support (OpenAI, Gemini, Mistral, Perplexity)
- Context-aware: Already fetches mood, intentions, streak from sessions
- Pattern: `createSystemPrompt(context)` → `sendMessage(userId, message)` → Save response
- Rate limiting: `chatSendLimiter` at 20 messages/hour

**Key Technical Decisions**:

1. **AI Provider Selection**: 
   - **DECISION (2025-10-14)**: **Google Gemini** (configured via `AI_PROVIDER=gemini`)
   - Rationale: Cost-effective, good quality for empathetic responses
   - Alternative options available: OpenAI GPT-4, Anthropic Claude
   - Must support whatever provider is configured via `AI_PROVIDER` env var

2. **Service Architecture**:
   - **Option A**: Create separate `RepairAIService` class (clean separation of concerns)
   - **Option B**: Extend `AIChatService` with `generateRepairSuggestion` method (reuse infrastructure)
   - **Recommendation**: Option A (separate service) - repair flow has unique requirements and safety constraints

3. **Rate Limiting**:
   - **Recommendation**: Separate rate limit for repair flow (10 flows per day per user)
   - Rationale: Repair flows are crisis moments and shouldn't be blocked by chat usage
   - Implementation: Create `repairFlowLimiter` in `rateLimiter.ts`

4. **Fallback Strategy**:
   - ALWAYS have safe fallback response connecting to SAMHSA hotline
   - Never block user from accessing repair flow due to AI failure
   - Log all AI failures for monitoring and prompt engineering improvements

5. **Prompt Engineering**:
   - Include evidence-based techniques in system prompt (HALT, Urge Surfing, Grounding)
   - Reference SAMHSA guidelines, NIDA research, SMART Recovery principles
   - Keep responses concise (3-4 sentences, ~150 words) for mobile UX
   - Validate responses before returning to user

**Clinical Validation Requirements**:
- System prompt must be reviewed by addiction recovery specialist (DEFERRED - post-implementation review)
- Validate AI responses align with harm reduction principles
- Test prompt with various scenarios before production deployment
- Document any deviations from evidence-based practices
- **NOTE**: Expert consultation scheduled for after initial implementation to validate approach

**Files to Create**:
- `api/_lib/services/repairAIService.ts` - New AI service for repair flow
- `api/_lib/services/__tests__/repairAIService.test.ts` - Unit tests for AI service

**Files to Modify**:
- `server/services/conversationEngine.ts` - Replace hardcoded lookup with AI call
- `api/_lib/middleware/rateLimiter.ts` - Add repair flow rate limiter (if separate limit)
- `api/repair/start.test.ts` - Update integration tests to mock AI service

**Files to Reference** (existing patterns):
- `api/_lib/services/aiChatService.ts` - AI integration pattern
- `api/chat/[action].ts` - Rate limiting application pattern
- `docs/REPAIR_FLOW_CONTENT_BLOCKER.md` - Problem definition and requirements

### Testing

**Test File Locations**:
- Unit tests: `api/_lib/services/__tests__/repairAIService.test.ts`
- Integration tests: `api/repair/start.test.ts` (update existing)
- Component tests: `client/src/components/repair/__tests__/RepairFlow.test.tsx` (no changes needed)

**Testing Frameworks**:
- Backend: Vitest + supertest (consistent with existing tests)
- Mocking: Mock AI service responses in tests (don't make real API calls)
- Test database: Use existing test database setup from Story 4.1

**Test Coverage Requirements**:
- All new code must have unit tests (RepairAIService methods)
- All existing Story 4.1 tests must continue to pass (16 tests)
- Integration tests must cover AI integration path and fallback path
- Prompt engineering tests validate response quality

**Running Tests**:
```bash
# Run all repair flow tests
npm test -- api/repair/start.test.ts

# Run new AI service unit tests
npm test -- api/_lib/services/__tests__/repairAIService.test.ts

# Run full test suite
npm test
```

---

### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-14 | 1.0 | Initial story creation: AI-Powered Repair Suggestions (Backend). Story created to address CRITICAL BLOCKER from Story 4.1 regarding hardcoded repair suggestions lacking therapeutic depth. Implements Option C (AI-powered contextual responses) from REPAIR_FLOW_CONTENT_BLOCKER.md. Includes comprehensive AC, technical context, integration strategy, and testing requirements. Story ready for Product Owner review and expert consultation. | Bob (Scrum Master) |
| 2025-10-14 | 1.1 | Product Owner decisions: (1) AI Provider = Google Gemini, (2) Expert consultation deferred to post-implementation review, (3) Approved to proceed with Story 4.1B (Frontend). Story ready for implementation. | Bob (Scrum Master) |
