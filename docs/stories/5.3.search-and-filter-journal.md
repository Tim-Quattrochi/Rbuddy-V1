# Story 5.3: Add Search and Filter to Journal History

### Status
Draft

### Story
**As an** authenticated user,
**I want** to search and filter my journal entries by date range and keywords,
**so that** I can quickly find specific reflections and track patterns in my recovery journey.

### Acceptance Criteria
1. A search input field is displayed at the top of the `/journal` page that allows users to enter keywords to filter journal entries.
2. A date range filter UI (e.g., date pickers or preset options like "Last 7 days", "Last 30 days", "All time") is available on the journal page.
3. When a user enters a keyword in the search field, the displayed entries are filtered to show only those containing the search term (case-insensitive).
4. When a user selects a date range, only entries created within that range are displayed.
5. Search and date filters can be combined (both filters applied simultaneously).
6. The backend API endpoint `GET /api/journal/history` is enhanced to accept optional query parameters: `search` (keyword) and `startDate`/`endDate` (ISO date strings).
7. The filtered results maintain pagination support (limit/offset) and return appropriate metadata.
8. A "Clear filters" button resets all active filters and displays the full unfiltered journal history.
9. The search and filter UI is responsive and follows the app's design system.
10. When no entries match the current filters, an appropriate empty state message is displayed (e.g., "No journal entries found matching your filters").

### Tasks / Subtasks
- [ ] **Task 1: Backend - Enhance Journal History API** (AC: #6, #7)
  - [ ] Update `api/journal/history.ts` to accept optional query parameters: `search`, `startDate`, `endDate`.
  - [ ] Implement keyword search filtering using SQL `LIKE` or `ILIKE` on the `body` column.
  - [ ] Implement date range filtering using SQL `WHERE` conditions on `createdAt`.
  - [ ] Ensure filters work in combination with existing pagination.
  - [ ] Add input validation for date parameters (valid ISO dates, startDate <= endDate).
  - [ ] Update response to maintain existing pagination metadata structure.
- [ ] **Task 2: Frontend - Create Search and Filter UI Components** (AC: #1, #2, #9)
  - [ ] Add a search input field component at the top of the Journal page using shadcn/ui `Input`.
  - [ ] Create date range filter UI using shadcn/ui components (Select, Popover, Calendar, or Radio Group for presets).
  - [ ] Add a "Clear filters" button that resets all filter states.
  - [ ] Ensure the filter UI is responsive and follows design system spacing/styling.
- [ ] **Task 3: Frontend - Implement Filter State Management** (AC: #3, #4, #5)
  - [ ] Add React state to manage search keyword and date range values.
  - [ ] Implement debounced search input to avoid excessive API calls.
  - [ ] Update the `useJournalHistory` hook to accept filter parameters.
  - [ ] Pass filter values as query parameters to the API endpoint.
  - [ ] Reset pagination offset when filters change.
- [ ] **Task 4: Frontend - Update Empty State** (AC: #10)
  - [ ] Modify the empty state in `Journal.tsx` to detect if filters are active.
  - [ ] Display filtered empty state message when filters are applied with no results.
  - [ ] Display original empty state message when no filters are active.
- [ ] **Task 5: Frontend - Clear Filters Functionality** (AC: #8)
  - [ ] Implement button handler to reset search keyword and date range state.
  - [ ] Trigger data refetch with cleared filter parameters.
  - [ ] Show/hide the clear button based on whether filters are active.
- [ ] **Task 6: Write Tests**
  - [ ] Write API integration tests for search and date filtering.
  - [ ] Test individual filters (search only, date only) and combined filters.
  - [ ] Test edge cases (invalid dates, empty search, special characters).
  - [ ] Write component tests for filter UI interactions.
  - [ ] Test debounced search behavior.
  - [ ] Test clear filters functionality.
  - [ ] Ensure pagination still works correctly with filters applied.

### Dev Notes
* **This story depends on Story 5.2** (View Journal History) - the journal history page and API endpoint must exist.
* **Search Implementation**: Use PostgreSQL `ILIKE` for case-insensitive search on the `body` field. Consider performance with large datasets - may need to add full-text search index in future if needed.
* **Date Range Filtering**: Use PostgreSQL date comparison operators. Ensure timezone handling is consistent.
* **Query Parameter Validation**: Sanitize and validate all user inputs to prevent SQL injection (Drizzle ORM should handle this, but validate date formats).
* **Debouncing**: Use a debounce delay of 300-500ms for the search input to reduce API calls while typing.
* **UX Considerations**: Show loading state when filters change. Consider showing active filter count/indicator.
* **Future Enhancements** (not in scope for this story):
  - Mood-based filtering (filter by specific moods recorded in the same session)
  - Sort order options (oldest first, newest first)
  - Saved searches or favorite filters
  - Export filtered results

#### Previous Story Insights
From Story 5.2:
- The `/api/journal/history` endpoint uses Drizzle ORM with proper authentication via `requireAuth` middleware [Source: docs/stories/5.2.view-journal-history.md#dev-agent-record]
- Current query structure: `db.select().from(interactions).where(and(eq(interactions.userId, userId), eq(interactions.contentType, "journal_entry"))).orderBy(desc(interactions.createdAt))`
- Pagination uses limit+1 pattern to detect `hasMore` without expensive COUNT queries [Source: api/journal/history.ts]
- The `formatJournalTimestamp` utility in `client/src/lib/datetime.ts` handles date display formatting [Source: docs/stories/5.2.view-journal-history.md#file-list]

#### Data Models
- **interactions table**: Contains `id`, `userId`, `body`, `contentType`, `createdAt` columns [Source: docs/architecture/4-data-models-and-schema-changes.md, shared/schema.ts]
- **Query filters will use**: `body` (text search), `createdAt` (date range), `userId` (auth scope), `contentType` (journal_entry constant)

#### API Specifications
**Enhanced Endpoint**: `GET /api/journal/history`
- **Auth**: Requires `requireAuth` middleware
- **New Query Parameters**:
  - `search` (optional, string): Keyword to search in entry body
  - `startDate` (optional, ISO date string): Filter entries created on or after this date
  - `endDate` (optional, ISO date string): Filter entries created on or before this date
  - `limit` (optional, number, default 20): Existing pagination
  - `offset` (optional, number, default 0): Existing pagination
- **Response Format** (unchanged):
  ```typescript
  {
    entries: Array<{ id: string; body: string; createdAt: string }>,
    pagination: { limit: number; offset: number; hasMore: boolean; nextOffset: number | null }
  }
  ```
- **Error Responses**: 400 for invalid date formats, 401 for unauthorized [Source: docs/architecture/6-api-design-and-integration.md pattern]

#### Component Specifications
**Updates to `client/src/pages/Journal.tsx`**:
- Add filter UI section above the journal entries list
- Use shadcn/ui components: `Input` (search), `Select` or `Popover` with `Calendar` (date picker), `Button` (clear filters)
- Implement local state for filter values
- Pass filters to `useJournalHistory` hook

**Updates to `client/src/hooks/useJournalHistory.ts`**:
- Accept filter parameters: `search?: string`, `dateRange?: { start?: string; end?: string }`
- Include filter params in query key for proper React Query caching
- Append filter query params to API fetch URL

#### File Locations
Based on project structure [Source: docs/architecture/8-source-tree.md]:
- **API**: `api/journal/history.ts` (UPDATE existing file)
- **Frontend Page**: `client/src/pages/Journal.tsx` (UPDATE existing file)
- **Frontend Hook**: `client/src/hooks/useJournalHistory.ts` (UPDATE existing file)
- **Tests**: 
  - `api/journal/history.test.ts` (UPDATE existing test file)
  - `client/src/pages/__tests__/Journal.test.tsx` (UPDATE existing test file)
- **New utility** (if needed): `client/src/lib/searchUtils.ts` for debounce logic

#### Testing Requirements
[Source: docs/architecture/10-coding-standards-testing-and-security.md, Story 5.2 testing patterns]
- **Test Frameworks**: Vitest + React Testing Library (frontend), Vitest + supertest (backend API)
- **Backend Tests** (`api/journal/history.test.ts`):
  - Test search filter with various keywords (single word, multiple words, special characters)
  - Test date range filters (startDate only, endDate only, both combined)
  - Test combined search + date filters
  - Test pagination with filters active
  - Test invalid date format handling (should return 400 error)
  - Test edge case: startDate > endDate (should return validation error)
  - Ensure filtered queries maintain userId scoping (security test)
- **Frontend Tests** (`client/src/pages/__tests__/Journal.test.tsx`):
  - Test search input renders and accepts user input
  - Test debounced search triggers API call after delay
  - Test date range picker renders and updates state
  - Test clear filters button resets all filters and refetches data
  - Test filtered empty state displays correct message
  - Test filter UI is accessible (keyboard navigation, ARIA labels)
  - Mock API responses for filtered data
- **Coverage Requirements**: All new code paths must be covered, especially filter validation and combination logic

#### Technical Constraints
- **Performance**: Search on large text fields can be slow. For now, use simple `ILIKE` pattern matching. If performance becomes an issue with many entries, consider adding PostgreSQL full-text search (GIN index on tsvector column) in a future story.
- **Security**: All SQL queries must use parameterized queries (Drizzle ORM handles this). Validate and sanitize date inputs to prevent injection attacks.
- **Debouncing**: Implement on frontend to reduce API load. Use `useMemo` or a debounce utility.

### Design Considerations
* Filter controls should be visually distinct but not overwhelming - consider using a collapsible "Filters" section or a subtle header area.
* Active filters should be clearly visible to the user (e.g., chip/badge indicators showing "Search: keyword" and "Date range: ...").
* The clear filters button should only be visible when filters are active.
* Consider using preset date range options (Today, Last 7 days, Last 30 days, All time) for better UX instead of or in addition to custom date pickers.
* Search placeholder text should be helpful: "Search journal entries..." or "Find entries by keyword...".
* Empty state for filtered results should encourage the user to adjust filters rather than suggesting they have no entries at all.

---
### Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-12 | 1.0 | Initial story creation for search and filter functionality on journal history. | Bob (Scrum Master) |

---
### Dev Agent Record

#### Agent Model Used
(To be filled by Dev Agent)

#### Debug Log References
(To be filled by Dev Agent)

#### Completion Notes List
(To be filled by Dev Agent)

#### File List
(To be filled by Dev Agent)

---
## QA Results

(To be filled by QA Agent after implementation)
