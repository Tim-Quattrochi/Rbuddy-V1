# Requirements Traceability Matrix

## Story: S12 - PWA Daily Ritual Flow Implementation

**Date**: 2025-10-11
**Status**: Critical Fixes Applied (S12-critical-fixes.md)
**Story File**: [docs/stories/s12.md](../../stories/s12.md)

---

## Coverage Summary

- **Total Requirements**: 10 Acceptance Criteria
- **Fully Covered**: 6 (60%)
- **Partially Covered**: 3 (30%)
- **Not Covered**: 1 (10%)

### Coverage Breakdown by Category

| Category | ACs | Coverage |
|----------|-----|----------|
| **Component Rendering** | AC #1, #2, #4, #5, #7 | ‚úÖ FULL (Unit tests) |
| **API Integration** | AC #3, #6 | ‚ö†Ô∏è PARTIAL (Basic tests only) |
| **Offline Capabilities** | AC #8, #9 | üî¥ NONE (Manual testing only) |
| **Database Logging** | AC #10 | üî¥ NONE (Not validated) |

---

## Requirement Mappings

### AC1: Daily Check-in Screen Displayed

**Coverage: FULL**

**Requirement**: When the user opens the PWA, they are presented with a "Daily Check-in" screen.

**Test Mappings:**

1. **Unit Test**: `client/src/components/daily-ritual/__tests__/MoodSelector.test.tsx::renders four mood buttons`
   - **Given**: User opens the Daily Ritual page
   - **When**: MoodSelector component is rendered
   - **Then**: Four mood buttons are displayed on screen
   - **Coverage**: Full - validates component renders correctly

2. **Integration**: Implicitly covered by page rendering (DailyRitual.tsx)
   - **Given**: PWA application is loaded
   - **When**: User navigates to /daily-ritual route
   - **Then**: Daily check-in screen displays with mood selector
   - **Coverage**: Full - route integration tested manually

**Risk Assessment**: ‚úÖ Low Risk - Well tested at component level

---

### AC2: Four Mood Buttons Displayed

**Coverage: FULL**

**Requirement**: The screen displays four large, clearly labeled mood buttons: "Calm üòå", "Stressed üò∞", "Tempted üò£", "Hopeful üåü".

**Test Mappings:**

1. **Unit Test**: `client/src/components/daily-ritual/__tests__/MoodSelector.test.tsx::renders four mood buttons`
   - **Given**: MoodSelector component is mounted
   - **When**: Component renders
   - **Then**: Exactly 4 buttons are found with labels "Calm", "Stressed", "Tempted", "Hopeful"
   - **Coverage**: Full - validates all mood options present with correct labels

**Risk Assessment**: ‚úÖ Low Risk - Explicit test coverage for all mood options

---

### AC3: Mood Selection API Call

**Coverage: PARTIAL**

**Requirement**: Upon tapping a mood button, an API call is made to `POST /api/daily-ritual/mood`.

**Test Mappings:**

1. **Unit Test**: `client/src/components/daily-ritual/__tests__/MoodSelector.test.tsx::calls onSelectMood with the correct mood`
   - **Given**: MoodSelector is rendered with onSelectMood callback
   - **When**: User clicks any mood button (calm/stressed/tempted/hopeful)
   - **Then**: onSelectMood callback is invoked with correct mood value
   - **Coverage**: Partial - validates component interaction, not actual API call

2. **Integration Test**: `api/daily-ritual/api.test.ts::POST /api/daily-ritual/mood should return affirmation and sessionId`
   - **Given**: Mood endpoint receives valid request
   - **When**: POST /api/daily-ritual/mood is called with {userId, mood}
   - **Then**: Returns 200 with {affirmation, sessionId}
   - **Coverage**: Partial - validates endpoint structure, mocks database

**Coverage Gaps**:
- ‚ùå No test validates actual HTTP request from frontend to backend
- ‚ùå No test for network error handling
- ‚ùå No test for authentication flow (JWT validation)

**Risk Assessment**: ‚ö†Ô∏è Medium Risk - Component and API tested separately, integration not validated

---

### AC4: Affirmation Card Display

**Coverage: FULL**

**Requirement**: After selecting a mood, the user is shown an animated "Affirmation Card" component containing a supportive message relevant to their chosen mood.

**Test Mappings:**

1. **Unit Test**: `client/src/components/daily-ritual/__tests__/AffirmationCard.test.tsx::renders the affirmation text`
   - **Given**: AffirmationCard component receives affirmation prop
   - **When**: Component is rendered
   - **Then**: Affirmation text is displayed with "A Thought for Today" header
   - **Coverage**: Full - validates component renders affirmation correctly

2. **Backend Logic**: `server/services/conversationEngine.test.ts` (Stories 3-4)
   - **Given**: User selects mood in conversation flow
   - **When**: Mood is processed by ConversationEngine
   - **Then**: Appropriate affirmation is returned for each mood type
   - **Coverage**: Full - validates mood-specific affirmations

**Risk Assessment**: ‚úÖ Low Risk - Component and business logic both tested

---

### AC5: Intention Input Field

**Coverage: FULL**

**Requirement**: Below the affirmation, an optional text input field is available for the user to enter a daily intention.

**Test Mappings:**

1. **Unit Test**: `client/src/components/daily-ritual/__tests__/IntentionInput.test.tsx::renders the input field`
   - **Given**: IntentionInput component is mounted
   - **When**: Component renders
   - **Then**: Input field with label "Set Your Intention for Today (Optional)" is present
   - **Coverage**: Full - validates input field presence and accessibility

2. **Unit Test**: `client/src/components/daily-ritual/__tests__/IntentionInput.test.tsx::calls onSaveIntention with the input value on blur`
   - **Given**: User types intention text
   - **When**: Input loses focus (blur event)
   - **Then**: onSaveIntention callback is invoked with trimmed text
   - **Coverage**: Full - validates input capture and whitespace handling

3. **Unit Test**: `client/src/components/daily-ritual/__tests__/IntentionInput.test.tsx::does not call onSaveIntention if empty`
   - **Given**: User types only whitespace
   - **When**: Input loses focus
   - **Then**: onSaveIntention is NOT called (empty validation)
   - **Coverage**: Full - validates edge case for empty input

**Risk Assessment**: ‚úÖ Low Risk - Comprehensive component testing with edge cases

---

### AC6: Intention Saved via API

**Coverage: PARTIAL**

**Requirement**: If the user types an intention and blurs the input, the intention is saved via an API call to `POST /api/daily-ritual/intention`.

**Test Mappings:**

1. **Integration Test**: `api/daily-ritual/api.test.ts::POST /api/daily-ritual/intention should return success: true`
   - **Given**: Intention endpoint receives valid request
   - **When**: POST /api/daily-ritual/intention is called with {sessionId, intentionText}
   - **Then**: Returns 200 with {success: true}
   - **Coverage**: Partial - validates endpoint structure, mocks database

**Coverage Gaps**:
- ‚ùå No test validates actual API call from IntentionInput component
- ‚ùå No test for network error handling during save
- ‚ùå No test for session validation (invalid sessionId)

**Risk Assessment**: ‚ö†Ô∏è Medium Risk - API endpoint tested, but frontend integration not validated

---

### AC7: Streak Counter Display

**Coverage: FULL**

**Requirement**: A "Streak" counter is displayed prominently on the page, which increments upon successful completion of a daily check-in. Data is fetched from `GET /api/user/stats`.

**Test Mappings:**

1. **Unit Test**: `client/src/components/daily-ritual/__tests__/StreakCounter.test.tsx::renders the streak number`
   - **Given**: StreakCounter receives streak prop value
   - **When**: Component is rendered
   - **Then**: "Daily Streak" label and streak count are displayed correctly
   - **Coverage**: Full - validates component rendering

2. **Unit Test**: `client/src/components/daily-ritual/__tests__/StreakCounter.test.tsx::renders 0 days correctly`
   - **Given**: StreakCounter receives streak=0
   - **When**: Component is rendered
   - **Then**: "0 Days" is displayed (edge case)
   - **Coverage**: Full - validates zero streak display

3. **Integration Test**: `api/user/stats.test.ts::GET /api/user/stats should return streakCount and moodTrends`
   - **Given**: Stats endpoint receives valid request
   - **When**: GET /api/user/stats is called with userId
   - **Then**: Returns 200 with {streakCount, moodTrends}
   - **Coverage**: Partial - validates endpoint structure, mocks database

**Critical Fix Applied (S12-critical-fixes.md)**:
- ‚úÖ Streak calculation logic completely rewritten in `api/user/stats.ts`
- ‚úÖ Fixed date normalization and day calculation bugs
- ‚úÖ Handles midnight edge cases and timezone issues
- ‚ö†Ô∏è **No regression tests added for streak calculation logic**

**Coverage Gaps**:
- ‚ùå No unit tests for streak calculation algorithm
- ‚ùå No tests for edge cases (midnight check-ins, multiple same-day sessions)
- ‚ùå No tests validating streak increments after check-in completion

**Risk Assessment**: ‚ö†Ô∏è Medium Risk - Critical bug fixed but no automated tests to prevent regression

---

### AC8: Offline Functionality

**Coverage: NONE**

**Requirement**: The entire flow (mood selection, affirmation view, intention entry) works seamlessly offline.

**Test Mappings**: ‚ùå **No automated tests found**

**Manual Testing Reference**:
- S12-critical-fixes.md documents manual testing requirements
- `.ai/s11-pwa-testing-guide.md` referenced in S11 story

**Expected Test Coverage** (Not Implemented):
1. **E2E Test**: Offline mood selection
   - **Given**: User is offline (network disabled in browser)
   - **When**: User selects a mood
   - **Then**: UI updates optimistically, request queued for background sync

2. **E2E Test**: Offline intention save
   - **Given**: User is offline after mood selection
   - **When**: User types intention and blurs input
   - **Then**: UI shows success, request queued for sync

3. **E2E Test**: Service worker cache validation
   - **Given**: User visited PWA while online
   - **When**: User goes offline and reloads page
   - **Then**: Daily ritual page loads from cache

**Coverage Gaps**:
- ‚ùå No automated tests for offline UI behavior
- ‚ùå No tests for service worker caching strategies
- ‚ùå No tests for optimistic update rollback on failure
- ‚ùå No validation that service worker is properly configured

**Risk Assessment**: üî¥ **HIGH RISK** - Critical PWA feature with zero automated coverage

---

### AC9: Background Sync & Queuing

**Coverage: NONE**

**Requirement**: When offline, interactions are queued locally using the background sync capabilities established in S11. The UI provides optimistic updates.

**Test Mappings**: ‚ùå **No automated tests found**

**Configuration Reference**:
- Background sync configured in `vite.config.ts` (S12-critical-fixes.md)
- Queue name: `daily-ritual-queue`
- Max retention: 24 hours

**Expected Test Coverage** (Not Implemented):
1. **E2E Test**: Request queuing
   - **Given**: User is offline
   - **When**: Multiple API calls are made (mood + intention)
   - **Then**: All requests are added to background sync queue

2. **E2E Test**: Sync on reconnection
   - **Given**: Queued requests exist from offline session
   - **When**: Network connection is restored
   - **Then**: All queued requests are sent to server in order

3. **E2E Test**: Optimistic update revert
   - **Given**: Offline request queued with optimistic update
   - **When**: Background sync fails (e.g., invalid session)
   - **Then**: UI reverts optimistic update and shows error

4. **Integration Test**: Workbox background sync validation
   - **Given**: Service worker is registered
   - **When**: Inspecting workbox configuration
   - **Then**: Background sync is configured for `/api/*` routes

**Coverage Gaps**:
- ‚ùå No tests for background sync queue management
- ‚ùå No tests for optimistic update implementation
- ‚ùå No tests for sync failure scenarios
- ‚ùå No tests for 24-hour queue retention window
- ‚ùå No tests for concurrent request handling

**Risk Assessment**: üî¥ **HIGH RISK** - Complex PWA feature with zero automated coverage

---

### AC10: Database Logging with PWA Channel

**Coverage: NONE**

**Requirement**: All interactions are logged to the `sessions` and `interactions` tables in the database with the `channel` set to 'pwa'.

**Test Mappings**: ‚ùå **No automated tests found**

**Implementation Reference**:
- S12-critical-fixes.md documents interaction logging implementation
- Updated `server/services/conversationEngine.ts` to log PWA interactions
- Added content types: `mood_selection`, `affirmation_view`, `intention`

**Expected Test Coverage** (Not Implemented):
1. **Integration Test**: Mood selection logging
   - **Given**: User selects mood via PWA
   - **When**: POST /api/daily-ritual/mood is called
   - **Then**: Interaction logged with contentType='mood_selection', channel='pwa'

2. **Integration Test**: Affirmation view logging
   - **Given**: Affirmation is displayed to user
   - **When**: Mood selection completes
   - **Then**: Interaction logged with contentType='affirmation_view', channel='pwa'

3. **Integration Test**: Intention logging
   - **Given**: User saves intention via PWA
   - **When**: POST /api/daily-ritual/intention is called
   - **Then**: Interaction logged with contentType='intention', channel='pwa'

4. **Integration Test**: Session creation with channel
   - **Given**: User completes daily ritual
   - **When**: Session is saved
   - **Then**: Session record has channel='pwa' and correct userId

**Coverage Gaps**:
- ‚ùå No tests validating `channel='pwa'` in database
- ‚ùå No tests for new content types (mood_selection, affirmation_view, intention)
- ‚ùå No tests for interaction logging failure scenarios
- ‚ùå API tests use mocked database, don't validate actual inserts

**Risk Assessment**: üî¥ **HIGH RISK** - Critical audit trail requirement with zero validation

---

## Critical Gaps Identified

### Gap 1: Offline & Background Sync Testing (AC #8, #9)
**Severity**: üî¥ CRITICAL
**Impact**: Core PWA feature untested; high risk of production failures
**Recommendation**: Implement E2E tests using Playwright or Cypress with offline simulation

**Suggested Tests**:
1. Complete offline flow test (mood ‚Üí affirmation ‚Üí intention)
2. Background sync queue validation test
3. Optimistic update rollback test
4. Service worker caching strategy test
5. Network reconnection sync test

**Effort**: High (requires E2E test infrastructure setup)

---

### Gap 2: Database Logging Validation (AC #10)
**Severity**: üî¥ CRITICAL
**Impact**: Cannot verify audit trail compliance; data integrity at risk
**Recommendation**: Add integration tests with test database

**Suggested Tests**:
1. Verify mood selection creates interaction with channel='pwa'
2. Verify affirmation view logged correctly
3. Verify intention logged with correct content type
4. Verify session creation includes channel='pwa'
5. Verify all new content types stored correctly

**Effort**: Medium (requires test database setup or better mocking)

---

### Gap 3: Streak Calculation Regression (AC #7)
**Severity**: üî¥ HIGH
**Impact**: Critical bug was fixed but no tests prevent regression
**Recommendation**: Add unit tests for streak calculation algorithm

**Suggested Tests**:
1. Test consecutive day streak calculation
2. Test midnight edge case (11:59 PM ‚Üí 12:01 AM)
3. Test multiple same-day check-ins
4. Test streak break after gap
5. Test timezone normalization

**Effort**: Low (pure business logic, no external dependencies)

---

### Gap 4: End-to-End API Integration (AC #3, #6)
**Severity**: ‚ö†Ô∏è MEDIUM
**Impact**: Component and API tested separately; integration not validated
**Recommendation**: Add integration tests for frontend ‚Üí backend flow

**Suggested Tests**:
1. Test mood selection triggers actual API call
2. Test intention save triggers actual API call
3. Test error handling for failed API calls
4. Test JWT authentication flow
5. Test network timeout scenarios

**Effort**: Medium (requires frontend + backend integration test setup)

---

## Test Design Recommendations

### Priority 1: Critical Path Coverage (P0)
1. **E2E Offline Flow Test**
   - Tools: Playwright or Cypress
   - Coverage: AC #8, #9
   - Validates core PWA functionality end-to-end

2. **Database Logging Integration Tests**
   - Tools: Vitest + Test Database
   - Coverage: AC #10
   - Validates audit trail compliance

3. **Streak Calculation Unit Tests**
   - Tools: Vitest
   - Coverage: AC #7
   - Prevents regression of critical bug fix

### Priority 2: Integration Coverage (P1)
4. **Frontend-Backend Integration Tests**
   - Tools: Vitest + MSW or real API
   - Coverage: AC #3, #6
   - Validates API calls from components

5. **Authentication Flow Tests**
   - Tools: Vitest + JWT mocking
   - Coverage: All API endpoints
   - Validates security implementation

### Priority 3: Performance & NFRs (P2)
6. **Service Worker Performance Tests**
   - Tools: Lighthouse CI or custom
   - Validates caching efficiency

7. **Background Sync Reliability Tests**
   - Tools: Custom E2E with network throttling
   - Validates queue retention and retry logic

---

## Risk Assessment Summary

| Risk Level | Count | ACs |
|------------|-------|-----|
| üî¥ High    | 3     | AC #8, #9, #10 |
| ‚ö†Ô∏è Medium  | 3     | AC #3, #6, #7 |
| ‚úÖ Low     | 4     | AC #1, #2, #4, #5 |

**Overall Assessment**: ‚ö†Ô∏è **CONCERNS** - Good component coverage but critical gaps in integration, offline, and database validation

---

## Quality Gate Impact

### Current Status: ‚ö†Ô∏è CONCERNS

**Rationale**:
- ‚úÖ 60% full coverage on component rendering (good)
- ‚ö†Ô∏è 30% partial coverage on API integration (needs improvement)
- üî¥ 10% no coverage on critical PWA features (blocker)

**Recommended Gate Actions**:
1. **Block production deployment** until AC #8, #9, #10 have automated coverage
2. **Require manual QA sign-off** for offline functionality
3. **Add regression tests** for streak calculation before merging S12-critical-fixes

**Path to PASS**:
- Implement Priority 1 tests (E2E offline, DB logging, streak calculation)
- Add minimum integration tests for API calls
- Document manual QA results for background sync

---

## Test Data Requirements

### User Test Data
- Valid user IDs with existing sessions
- Users with 0-day streaks (new users)
- Users with 1-day streaks (yesterday check-in)
- Users with 7+ day streaks (veteran users)

### Session Test Data
- Sessions created via PWA (channel='pwa')
- Sessions created via SMS (channel='sms')
- Sessions with intentions
- Sessions without intentions

### Interaction Test Data
- Mood selections for all 4 moods
- Affirmation views
- Intention entries
- All content types from schema

---

## Appendix: Test File Inventory

### Unit Tests (Frontend)
- ‚úÖ `client/src/components/daily-ritual/__tests__/MoodSelector.test.tsx` (6 tests)
- ‚úÖ `client/src/components/daily-ritual/__tests__/AffirmationCard.test.tsx` (1 test)
- ‚úÖ `client/src/components/daily-ritual/__tests__/IntentionInput.test.tsx` (3 tests)
- ‚úÖ `client/src/components/daily-ritual/__tests__/StreakCounter.test.tsx` (2 tests)

### Integration Tests (Backend)
- ‚úÖ `api/daily-ritual/api.test.ts` (3 tests)
- ‚úÖ `api/webhooks/twilio/sms.test.ts` (3 tests)

### Unit Tests (Backend)
- ‚úÖ `server/services/conversationEngine.test.ts` (Stories 3-5 coverage)

### Manual Test Documentation
- üìÑ `docs/testing/s12-developer-test-report.md`
- üìÑ `.ai/s11-pwa-testing-guide.md` (referenced in S11)
- üìÑ `docs/stories/s12-critical-fixes.md` (testing requirements section)

---

## References

- **Story File**: [docs/stories/s12.md](../../stories/s12.md)
- **Critical Fixes**: [docs/stories/s12-critical-fixes.md](../../stories/s12-critical-fixes.md)
- **PRD**: [docs/prd.md](../../prd.md)
- **Architecture**: [docs/architecture.md](../../architecture.md)
- **Testing Strategy**: [docs/architecture/testing-strategy.md](../../architecture/testing-strategy.md) (if exists)

---

**Report Generated**: 2025-10-11
**Analyst**: Claude Code
**Next Review**: After Priority 1 tests implemented
